<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamagocho</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Three.js -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js",
      "three/examples/jsm/loaders/GLTFLoader.js": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"
    }
  }
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #fff;
    }
    .wrap {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #161b22;
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 12px;
    }
    .btn {
      background: #21262d;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover { background: #30363d; }

    /* 3D –±–ª–æ–∫ */
    .pet3d {
      width: 100%;
      height: 360px;
      border-radius: 16px;
      overflow: hidden;
      background: radial-gradient(120% 120% at 50% 90%, #2c4a72 0%, #141e2b 70%);
      margin-bottom: 16px;
    }
    #pet3d canvas { display:block; width:100%!important; height:100%!important; }

    /* –°—Ç–∞—Ç—É—Å—ã */
    .bars {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .bar {
      background: #21262d;
      border-radius: 8px;
      padding: 6px;
      font-size: 14px;
    }
    .bar span { display:block; margin-bottom: 4px; }
    .progress {
      height: 6px;
      border-radius: 4px;
      background: #444;
      overflow:hidden;
    }
    .progress div {
      height: 100%;
      background: #58a6ff;
      width: 50%;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>üêπ Tamagocho</div>
        <div>Seeds: <span id="seeds">0</span></div>
      </div>

      <!-- 3D-—Ö–æ–º—è–∫ -->
      <div id="pet3d" class="pet3d"></div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div class="buttons">
        <div class="btn">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="btn">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <div class="btn">üìñ –ö–≤–µ—Å—Ç—ã</div>
        <div class="btn">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞</div>
        <div class="btn">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
        <div class="btn">‚öôÔ∏è –ê–¥–º–∏–Ω</div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å—ã -->
      <div class="bars">
        <div class="bar">
          <span>‚ù§Ô∏è –°—ã—Ç–æ—Å—Ç—å</span>
          <div class="progress"><div id="hunger" style="width:80%"></div></div>
        </div>
        <div class="bar">
          <span>‚ö° –≠–Ω–µ—Ä–≥–∏—è</span>
          <div class="progress"><div id="energy" style="width:75%"></div></div>
        </div>
        <div class="bar">
          <span>üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
          <div class="progress"><div id="mood" style="width:90%"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- three.js –∫–æ–¥ -->
  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";

    const mount = document.getElementById("pet3d");
    let renderer, scene, camera, controls, hamster;

    // —Å—Ü–µ–Ω–∞
    scene = new THREE.Scene();

    // –∫–∞–º–µ—Ä–∞
    const aspect = mount.clientWidth / mount.clientHeight;
    camera = new THREE.PerspectiveCamera(45, aspect, 0.01, 100);
    camera.position.set(0.6, 0.35, 1.2);

    // —Ä–µ–Ω–¥–µ—Ä–µ—Ä
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(mount.clientWidth, mount.clientHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = true;
    mount.appendChild(renderer.domElement);

    // —Å–≤–µ—Ç
    scene.add(new THREE.HemisphereLight(0xffffff, 0x101018, 1.1));
    const dir = new THREE.DirectionalLight(0xffffff, 1.6);
    dir.position.set(1.2, 1.6, 1.0);
    dir.castShadow = true;
    dir.shadow.mapSize.set(1024, 1024);
    scene.add(dir);

    // –∑–µ–º–ª—è –¥–ª—è —Ç–µ–Ω–∏
    const groundGeo = new THREE.CircleGeometry(0.6, 64);
    const groundMat = new THREE.ShadowMaterial({ opacity: 0.28 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // –∫–æ–Ω—Ç—Ä–æ–ª—ã
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.minDistance = 0.5;
    controls.maxDistance = 2.0;
    controls.minPolarAngle = Math.PI * 0.2;
    controls.maxPolarAngle = Math.PI * 0.49;

    // –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
    const loader = new GLTFLoader();
    const MODEL_URL = "./hamster.glb";

    loader.load(MODEL_URL, (gltf)=>{
      hamster = gltf.scene;
      hamster.traverse(o=>{
        if(o.isMesh){ o.castShadow = true; o.receiveShadow = true; }
      });
      scene.add(hamster);
      fitAndCenter(hamster);
      animate();
    }, undefined, (err)=>{
      console.error("GLB load error:", err);
    });

    // —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Å—à—Ç–∞–±
    function fitAndCenter(object){
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      object.position.sub(center);
      const targetHeight = 0.45;
      const scale = targetHeight / size.y;
      object.scale.setScalar(scale);

      const box2 = new THREE.Box3().setFromObject(object);
      const size2 = box2.getSize(new THREE.Vector3());
      const sphere = box2.getBoundingSphere(new THREE.Sphere());

      const fov = camera.fov * (Math.PI/180);
      const dist = Math.max(
        size2.y / (2 * Math.tan(fov/2)),
        size2.x / (2 * Math.tan(fov/2))
      );
      camera.position.set(sphere.center.x+dist*0.6, sphere.center.y+dist*0.35, sphere.center.z+dist*1.2);
      controls.target.copy(sphere.center);
      controls.update();

      ground.position.set(sphere.center.x, box2.min.y-0.001, sphere.center.z);
      ground.scale.set(1.2,1.2,1.2);
    }

    // —Ü–∏–∫–ª
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // —Ä–µ—Å–∞–π–∑
    function onResize(){
      const w = mount.clientWidth, h = mount.clientHeight;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setSize(w,h);
    }
    addEventListener("resize", onResize);
    new ResizeObserver(onResize).observe(mount);
  </script>
</body>
</html>
