<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tamagocho</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1620;
      --card:#151f2e;
      --text:#e6eef8;
      --muted:#9bb2d0;
      --accent:#8de87c;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --shadow2:0 10px 24px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:430px;margin:0 auto;padding:18px 16px 28px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:6px 2px 12px}
    .avatar{width:70px;height:70px;border-radius:16px;object-fit:cover;box-shadow:var(--shadow)}
    .h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:14px}
    .pet-box{display:flex;flex-direction:column;align-items:center;padding:12px 0 4px}
    .pet{width:265px;height:265px;border-radius:24px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    .bars{display:flex;gap:10px;margin-top:12px}
    .bar{flex:1;background:#0e1520;border-radius:10px;overflow:hidden}
    .bar label{display:flex;justify-content:space-between;padding:6px 10px;font-size:14px}
    .bar .fill{height:8px;background:linear-gradient(90deg,#00ffa3,#47a3ff);border-radius:999px;margin:0 8px 10px}
    .balance{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--card);border-radius:16px;padding:12px 14px;margin-top:14px;box-shadow:var(--shadow);
    }
    .balance b{font-size:18px}
    .shop{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      height:44px;border-radius:12px;border:none;cursor:pointer;
      font-weight:600;transition:.15s transform ease, .15s filter ease;
    }
    .btn:active{transform:translateY(1px);filter:brightness(.95)}
    .btn-accent{background:var(--accent);color:#05210e}
    .btn-ok{background:var(--ok);color:#041a0f}
    .btn-warn{background:var(--warn);color:#211502}
    .btn-ghost{background:#0e1520;color:var(--text);border:1px solid rgba(255,255,255,.06)}
    .footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
    .tag{display:inline-block;padding:2px 8px;background:#0e1520;border:1px solid rgba(255,255,255,.06);border-radius:999px}
    .spinner{
      width:18px;height:18px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;
      display:inline-block;animation:spin 1s linear infinite;margin-left:8px;vertical-align:-3px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{
      position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
      background:#0e1520;border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;font-size:14px;
      box-shadow:var(--shadow2);opacity:0;pointer-events:none;transition:.2s
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="h1" id="hello">–ü—Ä–∏–≤–µ—Ç!</h1>
        <div class="muted">–¢–≤–æ–π –ø–∏—Ç–æ–º–µ—Ü –∂–¥—ë—Ç –∑–∞–±–æ—Ç—ã üêπ</div>
      </div>
      <img class="avatar" src="./pet.webp" alt="–ü–∏—Ç–æ–º–µ—Ü-–∞–≤–∞—Ç–∞—Ä">
    </div>

    <div class="card pet-box">
      <img class="pet" src="./pet.webp" alt="–ü–∏—Ç–æ–º–µ—Ü">
      <div class="bars" aria-hidden="true">
        <div class="bar">
          <label><span>–°—ã—Ç–æ—Å—Ç—å</span><span>82%</span></label>
          <div class="fill" style="width:82%"></div>
        </div>
        <div class="bar">
          <label><span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span><span>67%</span></label>
          <div class="fill" style="width:67%"></div>
        </div>
      </div>
    </div>

    <div class="balance">
      <div class="muted">–ú–æ–Ω–µ—Ç—ã</div>
      <div><b id="coins">0</b></div>
    </div>

    <div class="shop">
      <button class="btn btn-accent" id="buy100">+100 –º–æ–Ω–µ—Ç</button>
      <button class="btn btn-ok" id="buy300">+300 –º–æ–Ω–µ—Ç</button>
      <button class="btn btn-warn" id="buy1000" style="grid-column:span 2">+1000 –º–æ–Ω–µ—Ç</button>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn btn-ghost" id="refresh" style="flex:1">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <button class="btn btn-ghost" id="share" style="flex:1">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <div class="footer">
      <span class="tag">v1.0</span>
      <div style="margin-top:6px">–û–ø–ª–∞—Ç–∞ –∑–∞—â–∏—â–µ–Ω–∞ ‚Ä¢ –ÆKassa</div>
    </div>
  </div>

  <div id="toast" class="toast">–ì–æ—Ç–æ–≤–æ</div>

  <script>
    const API = 'https://tamagocho-backend.onrender.com';
    const tg = window.Telegram?.WebApp; try { tg?.ready(); } catch(e){}
    const $ = (s)=>document.querySelector(s);
    const toast = (t,ms=1800)=>{ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), ms); };
    let me = {user_id:null,first_name:'',username:'',coins:0};
    const getInitData = ()=> (tg?.initData || '');

    async function loadMe(){
      try{
        $('#refresh').disabled=true; $('#refresh').innerHTML='–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ <span class="spinner"></span>';
        const r = await fetch(`${API}/api/me`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:getInitData()})});
        if(!r.ok) throw new Error(await r.text());
        me = await r.json();
        $('#coins').textContent = me.coins ?? 0;
        $('#hello').textContent = `–ü—Ä–∏–≤–µ—Ç, ${me.first_name || '–∏–≥—Ä–æ–∫'}!`;
      }catch(e){ console.error(e); toast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'); }
      finally{ $('#refresh').disabled=false; $('#refresh').textContent='–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å'; }
    }

    async function buyCoins(packId){
      const btn = ({1:$('#buy100'),2:$('#buy300'),3:$('#buy1000')})[packId];
      const prev = btn.textContent;
      try{
        btn.disabled=true; btn.innerHTML=prev+' <span class="spinner"></span>';
        const r = await fetch(`${API}/api/payments/create`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:getInitData(),packId})});
        if(!r.ok) throw new Error(await r.text());
        const data = await r.json();
        if(data.instant){ await loadMe(); tg?.HapticFeedback?.notificationOccurred('success'); toast('–ú–æ–Ω–µ—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!'); return; }
        const url = data.confirmation_url;
        if(tg?.openLink) tg.openLink(url,{try_instant_view:false}); else window.open(url,'_blank');
        toast('–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Å—å –∏ –æ–±–Ω–æ–≤–∏ –±–∞–ª–∞–Ω—Å');
      }catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞: '+(e?.message||'–ø–ª–∞—Ç—ë–∂')); }
      finally{
        btn.disabled=false;
        if(packId===1) btn.textContent='+100 –º–æ–Ω–µ—Ç';
        if(packId===2) btn.textContent='+300 –º–æ–Ω–µ—Ç';
        if(packId===3) btn.textContent='+1000 –º–æ–Ω–µ—Ç';
      }
    }

    function share(){
      const url='https://t.me/TamagochoBot';
      if(navigator.share) navigator.share({title:'–ú–æ–π –ø–∏—Ç–æ–º–µ—Ü Tamagocho',text:'–ó–∞–±–æ—Ç–∏–º—Å—è –æ –ø–∏—Ç–æ–º—Ü–µ –≤–º–µ—Å—Ç–µ!',url}).catch(()=>{});
      else if(tg?.openLink) tg.openLink(url); else window.open(url,'_blank');
    }

    $('#buy100').addEventListener('click',()=>buyCoins(1));
    $('#buy300').addEventListener('click',()=>buyCoins(2));
    $('#buy1000').addEventListener('click',()=>buyCoins(3));
    $('#refresh').addEventListener('click',loadMe);
    $('#share').addEventListener('click',share);

    loadMe();
  </script>
</body>
</html>
