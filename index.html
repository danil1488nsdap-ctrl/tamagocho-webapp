<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tamagocho</title>
  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1620;
      --panel:#151f2e;
      --panel-2:#0e1a27;
      --text:#e6eef8;
      --muted:#9bb2d0;
      --accent:#80d2ee;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#1f2c44;
      --btn-hover:#293a57;
      --border:rgba(0,0,0,.2);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Arial;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
    .header h1{font-size:18px;margin:0}
    .badge{background:var(--panel-2);border:1px solid var(--border);padding:6px 10px;border-radius:12px;font-weight:600}
    .content{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .btn{background:var(--btn);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--btn-hover)}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .bar{height:10px;background:#0b1520;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar>span{display:block;height:100%}
    .bar.ok>span{background:var(--ok)}
    .bar.warn>span{background:var(--warn)}
    .bar.bad>span{background:var(--bad)}
    /* –º–æ–¥–∞–ª–∫–∏ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:30}
    .modal.show{display:flex}
    .modal .box{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:720px;width:94%;max-height:80vh;overflow:auto}
    .box .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
    .box .head h3{margin:0;font-size:16px}
    .close{background:transparent;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:12px}
    .item{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .price{color:var(--accent);font-weight:700}
    .muted{color:var(--muted)}
    /* 3D –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #hamster3d{width:100%;height:360px;background:#0b1420;border:1px solid var(--border);border-radius:16px;overflow:hidden}
    /* –º–∏–Ω–∏-–∏–≥—Ä–∞ (—Ä–µ–∞–∫—Ü–∏—è) */
    .game-area{height:260px;border:1px dashed var(--border);border-radius:16px;display:flex;align-items:center;justify-content:center;gap:12px;background:var(--panel-2)}
    .pill{padding:8px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border)}
    .footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>üêπ Tamagocho</h1>
        <div class="badge">Seeds: <span id="seeds">250</span></div>
      </div>

      <div class="content">
        <!-- –•–ï–î–ï–† –° –î–ï–ô–°–¢–í–ò–Ø–ú–ò -->
        <div class="btn-row" style="margin-bottom:10px">
          <button class="btn" id="btnShop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
          <button class="btn" id="btnInv">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
          <button class="btn" id="btnQuests">üìú –ö–≤–µ—Å—Ç—ã</button>
          <button class="btn" id="btnMiniGame">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞</button>
          <button class="btn" id="btnLeaderboard">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
          <button class="btn" id="btnAdmin" style="display:none">üõ†Ô∏è –ê–¥–º–∏–Ω</button>
        </div>

        <!-- 3D –•–û–ú–Ø–ö -->
        <div id="hamster3d"></div>

        <!-- –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò -->
        <div class="grid" style="margin-top:12px">
          <div class="col card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>üíö –°—ã—Ç–æ—Å—Ç—å <span id="hungerText" class="muted">100%</span></div>
              <div class="btn-row">
                <button class="btn" id="feedSmall">üç™ +10</button>
                <button class="btn" id="feedFull">üçó –ü–æ–ª–Ω–∞—è</button>
              </div>
            </div>
            <div class="bar ok"><span id="hungerBar" style="width:100%"></span></div>
          </div>

          <div class="col card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è <span id="energyText" class="muted">100%</span></div>
              <div class="btn-row">
                <button class="btn" id="sleepShort">üõèÔ∏è +10</button>
                <button class="btn" id="sleepFull">üò¥ –ü–æ–ª–Ω–∞—è</button>
              </div>
            </div>
            <div class="bar ok"><span id="energyBar" style="width:100%"></span></div>
          </div>

          <div class="col card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ <span id="moodText" class="muted">100%</span></div>
              <div class="btn-row">
                <button class="btn" id="playSmall">üß∏ +10</button>
                <button class="btn" id="playFull">üéâ –ü–æ–ª–Ω–∞—è</button>
              </div>
            </div>
            <div class="bar ok"><span id="moodBar" style="width:100%"></span></div>
          </div>

          <div class="col card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>üßº –ì–∏–≥–∏–µ–Ω–∞ <span id="hygieneText" class="muted">100%</span></div>
              <div class="btn-row">
                <button class="btn" id="washSmall">ü´ß +10</button>
                <button class="btn" id="washFull">üõÅ –ü–æ–ª–Ω–∞—è</button>
              </div>
            </div>
            <div class="bar ok"><span id="hygieneBar" style="width:100%"></span></div>
          </div>
        </div>

        <div class="footer-note">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–∞–¥–∞—é—Ç. –í—ã–ø–æ–ª–Ω—è–π –∫–≤–µ—Å—Ç—ã –∏ –º–∏–Ω–∏-–∏–≥—Ä—ã, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å Seeds –∏ –¥–µ—Ä–∂–∞—Ç—å –ø–∏—Ç–æ–º—Ü–∞ —Å—á–∞—Å—Ç–ª–∏–≤—ã–º.</div>
      </div>
    </div>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ò -->
  <!-- –ú–∞–≥–∞–∑–∏–Ω -->
  <div class="modal" id="shopModal">
    <div class="box">
      <div class="head">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
        <button class="close" data-close="shopModal">√ó</button>
      </div>
      <div class="list" id="shopList"></div>
    </div>
  </div>

  <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
  <div class="modal" id="invModal">
    <div class="box">
      <div class="head">
        <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <button class="close" data-close="invModal">√ó</button>
      </div>
      <div class="list" id="invList"></div>
    </div>
  </div>

  <!-- –ö–≤–µ—Å—Ç—ã -->
  <div class="modal" id="questsModal">
    <div class="box">
      <div class="head">
        <h3>üìú –ö–≤–µ—Å—Ç—ã</h3>
        <button class="close" data-close="questsModal">√ó</button>
      </div>
      <div class="content" id="questsBody" style="padding:12px"></div>
    </div>
  </div>

  <!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞ -->
  <div class="modal" id="gameModal">
    <div class="box">
      <div class="head">
        <h3>üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞ ¬´–†–µ–∞–∫—Ü–∏—è¬ª</h3>
        <button class="close" data-close="gameModal">√ó</button>
      </div>
      <div class="content">
        <div class="game-area" id="reactionArea">
          <div class="pill">–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º –∫–ª–∏–∫–∞–π –ø–æ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–º —Ü–µ–ª—è–º</div>
        </div>
        <div class="btn-row" style="margin-top:12px">
          <button class="btn" id="gameStart">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
          <button class="btn" id="gameStop">‚èπ –°—Ç–æ–ø</button>
          <span class="pill">–¢–µ–∫—É—â–∏–π —Å—á—ë—Ç: <b id="gameScore">0</b></span>
          <span class="pill">–†–µ–∫–æ—Ä–¥: <b id="gameBest">0</b></span>
        </div>
        <div class="footer-note">–ó–∞ 30 —Å–µ–∫ –Ω–∞–±–µ—Ä–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –æ—á–∫–æ–≤. –ó–∞ –∫–∞–∂–¥—ã–µ 5 –æ—á–∫–æ–≤ ‚Äî +3 Seeds, –Ω–µ–º–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —ç–Ω–µ—Ä–≥–∏–∏.</div>
      </div>
    </div>
  </div>

  <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
  <div class="modal" id="lbModal">
    <div class="box">
      <div class="head">
        <h3>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π)</h3>
        <button class="close" data-close="lbModal">√ó</button>
      </div>
      <div class="content">
        <ol id="lbList"></ol>
        <div class="footer-note">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –≤–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –±—ç–∫–µ–Ω–¥ (BACKEND_URL).</div>
      </div>
    </div>
  </div>

  <!-- –ê–¥–º–∏–Ω -->
  <div class="modal" id="adminModal">
    <div class="box">
      <div class="head">
        <h3>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <button class="close" data-close="adminModal">√ó</button>
      </div>
      <div class="content">
        <div class="btn-row">
          <button class="btn" data-admin="seeds50">+50 Seeds</button>
          <button class="btn" data-admin="seeds500">+500 Seeds</button>
          <button class="btn" data-admin="fullAll">–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∞</button>
          <button class="btn" data-admin="giveCosmetic">–í—ã–¥–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä</button>
          <button class="btn" data-admin="clear">–û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="footer-note">–≠—Ç–∞ –ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞. ID –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å.</div>
      </div>
    </div>
  </div>

  <!-- === –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–±–µ–∑ –º–æ–¥—É–ª–µ–π) ==================================== -->
  <script>
    // --- Telegram user / admin check ---
    const tg = window.Telegram?.WebApp;
    tg && tg.expand();
    const userId = tg?.initDataUnsafe?.user?.id || null;
    const OWNER_ID = 1907547038; // —Ç–≤–æ–π ID

    // --- –•–µ–ª–ø–µ—Ä—ã ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
    const state = JSON.parse(localStorage.getItem('tmg_state_v1') || 'null') || {
      seeds: 250,
      stats: { hunger: 100, energy: 100, mood: 100, hygiene: 100 },
      inv: [], // {id, title, type, value, premium}
      ownedCosmetics: [], // —Å–ø–∏—Å–æ–∫ id –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
      bestScore: 0,
      lb: [], // –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
      lastTick: Date.now()
    };

    const SHOP = [
      { id:'snack',  title:'–ü–µ—á–µ–Ω—å–∫–∞', type:'food', value:10, price:5 },
      { id:'meal',   title:'–ö—É—Ä–∏—Ü–∞',   type:'food', value:100, price:25 },
      { id:'nap',    title:'–ö–æ—Ñ–µ-–±—Ä–µ–π–∫', type:'rest', value:10, price:5 },
      { id:'sleep',  title:'–ì–ª—É–±–æ–∫–∏–π —Å–æ–Ω', type:'rest', value:100, price:25 },
      { id:'toy',    title:'–ò–≥—Ä—É—à–∫–∞', type:'fun', value:10, price:5 },
      { id:'party',  title:'–í–µ—á–µ—Ä–∏–Ω–∫–∞', type:'fun', value:100, price:25 },
      { id:'soap',   title:'–ú—ã–ª–æ', type:'clean', value:10, price:5 },
      { id:'bath',   title:'SPA',  type:'clean', value:100, price:25 },
      // –∫–æ—Å–º–µ—Ç–∏–∫–∞ (–ø—Ä–µ–º–∏—É–º-–∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã)
      { id:'hat_red',  title:'–ö—Ä–∞—Å–Ω–∞—è —à–∞–ø–∫–∞', type:'cosmetic', value:0, price:120, premium:true },
      { id:'glasses',  title:'–û—á–∫–∏', type:'cosmetic', value:0, price:120, premium:true }
    ];

    function save(){ localStorage.setItem('tmg_state_v1', JSON.stringify(state)); }
    function clamp(v){ return Math.max(0, Math.min(100, v)); }

    // –¢–∏–∫–∏ ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
    function tick(){
      const now = Date.now();
      const dtMin = Math.max(0, Math.floor((now - state.lastTick)/60000)); // –º–∏–Ω—É—Ç—ã
      if(dtMin>0){
        state.lastTick = now;
        // —É–±—ã–≤–∞–Ω–∏–µ
        state.stats.hunger  = clamp(state.stats.hunger  - dtMin*2);
        state.stats.energy  = clamp(state.stats.energy  - dtMin*1.5);
        state.stats.mood    = clamp(state.stats.mood    - dtMin*1.5);
        state.stats.hygiene = clamp(state.stats.hygiene - dtMin*1.2);
        save();
        renderStats();
      }
    }
    setInterval(tick, 15000); // –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º

    // --- –†–µ–Ω–¥–µ—Ä—ã UI ---
    function barClass(val){
      if(val>=60) return 'bar ok';
      if(val>=30) return 'bar warn';
      return 'bar bad';
    }
    function renderStats(){
      $('#seeds').textContent = state.seeds;

      const S = state.stats;
      $('#hungerText').textContent = S.hunger+'%';
      $('#energyText').textContent = S.energy+'%';
      $('#moodText').textContent   = S.mood+'%';
      $('#hygieneText').textContent= S.hygiene+'%';

      const hungerBar = $('#hungerBar').parentElement; hungerBar.className = barClass(S.hunger);
      const energyBar = $('#energyBar').parentElement; energyBar.className = barClass(S.energy);
      const moodBar   = $('#moodBar').parentElement;   moodBar.className   = barClass(S.mood);
      const hygBar    = $('#hygieneBar').parentElement;hygBar.className    = barClass(S.hygiene);

      $('#hungerBar').style.width = S.hunger+'%';
      $('#energyBar').style.width = S.energy+'%';
      $('#moodBar').style.width   = S.mood+'%';
      $('#hygieneBar').style.width= S.hygiene+'%';
    }

    function renderShop(){
      const root = $('#shopList'); root.innerHTML = '';
      SHOP.forEach(p=>{
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div style="font-weight:700">${p.title}</div>
          <div class="muted">${p.type==='cosmetic'?'–ê–∫—Å–µ—Å—Å—É–∞—Ä':'–ü—Ä–µ–¥–º–µ—Ç'} ${p.premium?'(–ø—Ä–µ–º–∏—É–º)':''}</div>
          <div class="price">üí† ${p.price}</div>
          <button class="btn" data-buy="${p.id}">–ö—É–ø–∏—Ç—å</button>
        `;
        root.appendChild(div);
      });
    }

    function renderInv(){
      const root = $('#invList'); root.innerHTML='';
      if(!state.inv.length && !state.ownedCosmetics.length){
        root.innerHTML = `<div class="item"><div class="muted">–ü—É—Å—Ç–æ. –ö—É–ø–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ.</div></div>`;
        return;
      }
      state.inv.forEach((it,idx)=>{
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML=`
          <div><b>${it.title}</b></div>
          <div class="muted">–¢–∏–ø: ${it.type}, +${it.value}</div>
          <div class="btn-row">
            <button class="btn" data-use="${idx}">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
            <button class="btn" data-drop="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        root.appendChild(div);
      });
      // –ö–æ—Å–º–µ—Ç–∏–∫–∞ (–ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–ª–∏—á–∏–µ)
      state.ownedCosmetics.forEach(id=>{
        const meta = SHOP.find(s=>s.id===id);
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML=`
          <div><b>${meta?.title||id}</b></div>
          <div class="muted">–ê–∫—Å–µ—Å—Å—É–∞—Ä</div>
          <div class="btn-row"><button class="btn" disabled>–ù–∞–¥–µ—Ç–æ</button></div>
        `;
        root.appendChild(div);
      });
    }

    function renderLB(){
      // –ó–∞–ø–∏—à–µ–º —Ç–µ–∫—É—â–∏–π bestScore
      $('#lbList').innerHTML = (state.lb||[]).sort((a,b)=>b.score-a.score)
        .slice(0,20)
        .map((r,i)=>`<li>${i+1}. ${r.name} ‚Äî <b>${r.score}</b></li>`).join('') || '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
    }

    // --- –î–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ —Å—Ç–∞—Ç–∞–º–∏ ---
    function applyItem(item){
      const S = state.stats;
      if(item.type==='food')   S.hunger  = clamp(S.hunger + item.value);
      if(item.type==='rest')   S.energy  = clamp(S.energy + item.value);
      if(item.type==='fun')    S.mood    = clamp(S.mood   + item.value);
      if(item.type==='clean')  S.hygiene = clamp(S.hygiene+ item.value);
      save(); renderStats();
    }

    // --- –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ ---
    function openModal(id){ $('#'+id).classList.add('show'); }
    function closeModal(id){ $('#'+id).classList.remove('show'); }
    $$('#btnShop, #btnInv, #btnQuests, #btnMiniGame, #btnLeaderboard, #btnAdmin').forEach(()=>{});
    $('#btnShop').onclick = ()=>{ renderShop(); openModal('shopModal'); }
    $('#btnInv').onclick  = ()=>{ renderInv();  openModal('invModal'); }
    $('#btnQuests').onclick=()=>{ renderQuests(); openModal('questsModal'); }
    $('#btnMiniGame').onclick=()=>{ resetGame(); openModal('gameModal'); }
    $('#btnLeaderboard').onclick=()=>{ renderLB(); openModal('lbModal'); }
    $('#btnAdmin').onclick=()=>{ openModal('adminModal'); }
    $$('.close').forEach(btn=> btn.onclick = ()=> closeModal(btn.dataset.close));

    // --- –ö–Ω–æ–ø–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–±—ã—Å—Ç—Ä—ã–µ) ---
    $('#feedSmall').onclick = ()=>{ if(state.seeds>=2){ state.seeds-=2; applyItem({type:'food', value:10, title:'–ü–µ—Ä–µ–∫—É—Å'}); save(); renderStats(); } };
    $('#feedFull').onclick  = ()=>{ if(state.seeds>=15){ state.seeds-=15; applyItem({type:'food', value:100, title:'–û–±–µ–¥'}); save(); renderStats(); } };
    $('#sleepShort').onclick= ()=>{ applyItem({type:'rest', value:10, title:'–ö–æ—Ñ–µ-–±—Ä–µ–π–∫'}); save(); renderStats(); };
    $('#sleepFull').onclick = ()=>{ applyItem({type:'rest', value:100, title:'–°–æ–Ω'}); save(); renderStats(); };
    $('#playSmall').onclick = ()=>{ if(state.seeds>=2){ state.seeds-=2; applyItem({type:'fun', value:10, title:'–ò–≥—Ä–∞'}); save(); renderStats(); } };
    $('#playFull').onclick  = ()=>{ if(state.seeds>=15){ state.seeds-=15; applyItem({type:'fun', value:100, title:'–ü—Ä–∞–∑–¥–Ω–∏–∫'}); save(); renderStats(); } };
    $('#washSmall').onclick = ()=>{ if(state.seeds>=1){ state.seeds-=1; applyItem({type:'clean', value:10, title:'–£–º—ã—Ç—å—Å—è'}); save(); renderStats(); } };
    $('#washFull').onclick  = ()=>{ if(state.seeds>=10){ state.seeds-=10; applyItem({type:'clean', value:100, title:'SPA'}); save(); renderStats(); } };

    // --- –ü–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ ---
    $('#shopList').addEventListener('click', (e)=>{
      const id = e.target.dataset.buy;
      if(!id) return;
      const product = SHOP.find(p=>p.id===id);
      if(!product) return;
      if(state.seeds < product.price){ tg?.showPopup?.({title:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Seeds',message:'–ó–∞—Ä–∞–±–æ—Ç–∞–π –µ—â—ë –≤ –∫–≤–µ—Å—Ç–∞—Ö –∏–ª–∏ –º–∏–Ω–∏-–∏–≥—Ä–∞—Ö.'}); return; }

      state.seeds -= product.price;
      if(product.type==='cosmetic'){
        if(!state.ownedCosmetics.includes(product.id)) state.ownedCosmetics.push(product.id);
      }else{
        state.inv.push({id:product.id, title:product.title, type:product.type, value:product.value});
      }
      save(); renderStats(); renderInv();
      tg?.HapticFeedback?.notificationOccurred('success');
    });

    // --- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: use/drop ---
    $('#invList').addEventListener('click',(e)=>{
      const iUse  = e.target.dataset.use;
      const iDrop = e.target.dataset.drop;
      if(iUse!==undefined){
        const idx = +iUse;
        const item = state.inv[idx];
        if(item){ applyItem(item); state.inv.splice(idx,1); save(); renderInv(); }
      }
      if(iDrop!==undefined){
        const idx = +iDrop;
        state.inv.splice(idx,1); save(); renderInv();
      }
    });

    // --- –ö–≤–µ—Å—Ç—ã (3 —à—Ç) ---
    function renderQuests(){
      const body = $('#questsBody');
      const today = new Date().toDateString();
      const key = 'tmg_quests_'+today;
      let q = JSON.parse(localStorage.getItem(key) || 'null');
      if(!q){
        q = [
          {id:'feed3',  title:'–ü–æ–∫–æ—Ä–º–∏ –ø–∏—Ç–æ–º—Ü–∞ 3 —Ä–∞–∑–∞', progress:0, need:3, reward:15},
          {id:'play2',  title:'–ü–æ–∏–≥—Ä–∞–π 2 —Ä–∞–∑–∞',        progress:0, need:2, reward:10},
          {id:'wash1',  title:'–ü–æ–º–æ–π 1 —Ä–∞–∑',          progress:0, need:1, reward:7},
        ];
        localStorage.setItem(key, JSON.stringify(q));
      }
      body.innerHTML = '';
      q.forEach((it,idx)=>{
        const done = it.progress>=it.need;
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div><b>${it.title}</b></div>
          <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${it.progress}/${it.need}</div>
          <div class="btn-row">
            <button class="btn" data-q="${idx}" ${done?'disabled':''}>–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É (+${it.reward} Seeds)</button>
          </div>
        `;
        body.appendChild(row);
      });

      body.onclick = (e)=>{
        const id = e.target.dataset.q;
        if(id===undefined) return;
        const i = +id;
        if(q[i].progress>=q[i].need){ // –∑–∞–±–∏—Ä–∞–µ–º
          state.seeds += q[i].reward;
          q[i].progress = -999; // –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–¥–∞–Ω–æ
          localStorage.setItem(key, JSON.stringify(q));
          save(); renderStats(); renderQuests();
          tg?.HapticFeedback?.notificationOccurred('success');
        }
      };

      // ¬´–∫—Ä—é—á–∫–∏¬ª –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–≤–µ—Å—Ç–æ–≤
      window.__questHook = (act)=>{
        if(act==='feed'){ if(q[0].progress>=0 && q[0].progress<q[0].need){ q[0].progress++; } }
        if(act==='play'){ if(q[1].progress>=0 && q[1].progress<q[1].need){ q[1].progress++; } }
        if(act==='wash'){ if(q[2].progress>=0 && q[2].progress<q[2].need){ q[2].progress++; } }
        localStorage.setItem(key, JSON.stringify(q));
      };
    }

    // –ø—Ä–∏–≤—è–∂–µ–º –∫–≤–µ—Å—Ç—ã –∫ –±—ã—Å—Ç—Ä—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º
    $('#feedSmall').addEventListener('click',()=>window.__questHook?.('feed'));
    $('#feedFull').addEventListener('click',()=>window.__questHook?.('feed'));
    $('#playSmall').addEventListener('click',()=>window.__questHook?.('play'));
    $('#playFull').addEventListener('click',()=>window.__questHook?.('play'));
    $('#washSmall').addEventListener('click',()=>window.__questHook?.('wash'));
    $('#washFull').addEventListener('click',()=>window.__questHook?.('wash'));

    // --- –ú–∏–Ω–∏-–∏–≥—Ä–∞ ¬´–†–µ–∞–∫—Ü–∏—è¬ª ---
    let gTimer=null, gSpawns=null, gScore=0;
    function resetGame(){
      gScore=0; $('#gameScore').textContent='0';
      $('#gameBest').textContent = state.bestScore||0;
      $('#reactionArea').innerHTML = `<div class="pill">–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, –∑–∞—Ç–µ–º –∫–ª–∏–∫–∞–π –ø–æ —Ü–µ–ª—è–º</div>`;
    }
    function spawnTarget(){
      const area = $('#reactionArea');
      const t = document.createElement('button');
      t.className='btn';
      t.style.position='absolute';
      const r = area.getBoundingClientRect();
      const x = Math.random()*(r.width-80)+10, y=Math.random()*(r.height-60)+10;
      t.style.left = x+'px'; t.style.top = y+'px';
      t.textContent = 'üéØ';
      t.onclick = ()=>{
        gScore++; $('#gameScore').textContent = gScore;
        t.remove();
      };
      area.appendChild(t);
      setTimeout(()=> t.remove(), 1000+Math.random()*1200);
    }
    $('#gameStart').onclick = ()=>{
      resetGame();
      const area = $('#reactionArea');
      area.style.position='relative';
      const end = Date.now()+30000;
      gSpawns = setInterval(spawnTarget, 450);
      gTimer  = setInterval(()=>{
        if(Date.now()>end){
          clearInterval(gSpawns); clearInterval(gTimer);
          // –Ω–∞–≥—Ä–∞–¥–∞: –∑–∞ –∫–∞–∂–¥—ã–µ 5 –æ—á–∫–æ–≤ ‚Äî +3 Seeds, –∏ +5 –∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é/—ç–Ω–µ—Ä–≥–∏–∏ (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)
          const bonus = Math.floor(gScore/5)*3;
          state.seeds += bonus;
          state.stats.mood = clamp(state.stats.mood+5);
          state.stats.energy = clamp(state.stats.energy+5);
          if(gScore > (state.bestScore||0)) state.bestScore = gScore;

          // –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
          const name = tg?.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫';
          state.lb.push({name, score:gScore, ts:Date.now()});

          save(); renderStats();
          tg?.showPopup?.({title:'–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞',message:`–°—á—ë—Ç: ${gScore}\n–ù–∞–≥—Ä–∞–¥–∞: +${bonus} Seeds`});
        }
      }, 250);
    };
    $('#gameStop').onclick = ()=>{
      clearInterval(gSpawns); clearInterval(gTimer); resetGame();
    };

    // --- –ê–¥–º–∏–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) ---
    if(userId === OWNER_ID){ $('#btnAdmin').style.display='inline-block'; }
    $('#adminModal').addEventListener('click',(e)=>{
      const k = e.target.dataset.admin;
      if(!k) return;
      if(userId !== OWNER_ID){ tg?.showPopup?.({title:'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞',message:'–≠—Ç–∞ –ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞.'}); return; }
      if(k==='seeds50')  state.seeds+=50;
      if(k==='seeds500') state.seeds+=500;
      if(k==='fullAll'){ Object.keys(state.stats).forEach(k=>state.stats[k]=100); }
      if(k==='giveCosmetic'){ if(!state.ownedCosmetics.includes('hat_red')) state.ownedCosmetics.push('hat_red'); }
      if(k==='clear'){ localStorage.removeItem('tmg_state_v1'); location.reload(); return; }
      save(); renderStats(); renderInv();
      tg?.HapticFeedback?.notificationOccurred('success');
    });

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    renderStats();
    tick(); // –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ç–∏–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ
  </script>

  <!-- === THREE.JS / 3D-–ú–û–î–ï–õ–¨ (—á–µ—Ä–µ–∑ –º–æ–¥—É–ª–∏) ============================ -->
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/loaders/GLTFLoader.js';

    const container = document.getElementById('hamster3d');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, container.clientWidth/container.clientHeight, 0.1, 100);
    camera.position.set(0, 1.2, 2.6);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 2.0);
    const dir  = new THREE.DirectionalLight(0xffffff, 1.5);
    dir.position.set(2,3,4);
    scene.add(hemi, dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // –ü–ª–æ—â–∞–¥–∫–∞
    const plane = new THREE.Mesh(
      new THREE.CircleGeometry(2.5, 48),
      new THREE.MeshStandardMaterial({ color: 0x0d1826, roughness:.9, metalness:0 })
    );
    plane.rotation.x = -Math.PI/2;
    plane.position.y = -1.02;
    scene.add(plane);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
    const loader = new GLTFLoader();
    loader.load('./hamster.glb', (gltf)=>{
      const root = gltf.scene;
      root.position.set(0,-1,0);
      root.scale.set(1,1,1);
      scene.add(root);
      // –ª—ë–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
      const clock = new THREE.Clock();
      (function spin(){
        const t = clock.getElapsedTime();
        root.rotation.y = Math.sin(t*0.5)*0.3;
        requestAnimationFrame(spin);
      })();
    }, undefined, (err)=>{
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ hamster.glb', err);
      // –§–æ–ª–ª–±–µ–∫: –ø—Ä–æ—Å—Ç–∞—è —Å—Ñ–µ—Ä–∫–∞, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞—à–ª–∞—Å—å
      const fallback = new THREE.Mesh(
        new THREE.SphereGeometry(0.8, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xffc78f, roughness:.6 })
      );
      fallback.position.set(0,-0.2,0);
      scene.add(fallback);
    });

    // —Ä–µ—Å–∞–π–∑
    new ResizeObserver(()=>{
      const w = container.clientWidth || 300;
      const h = container.clientHeight || 200;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h);
    }).observe(container);

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
