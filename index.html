<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tamagocho</title>

  <!-- Telegram Mini Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- three.js + GLTFLoader –¥–ª—è 3D-–ø–∏—Ç–æ–º—Ü–∞ -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    :root{
      --bg:#0f1620; --text:#e6eef8; --muted:#8b9db0; --ok:#3d9e59; --warn:#f59e0b; --accent:#80d0e0;
      --card:#151e2f; --card2:#0e1320; --bar:#1f2a3d; --barok:#39d98a; --barbad:#e76f51;
      --link:#80d0ff; --brand:#6aaef5;
    }
    *{box-sizing:border-box}
    body{margin:0; color:var(--text); background:var(--bg); font:16px/1.35 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1080px; margin:0 auto; padding:16px}
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .title{font-weight:700; font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center}
    .card{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid #1d2940; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .viewport{position:relative; height:420px; overflow:hidden}
    canvas.webgl{display:block; width:100%; height:100%}

    .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:12px 0}
    .bar{background:var(--bar); border-radius:10px; padding:8px}
    .bar>div{height:12px; border-radius:9px; background:linear-gradient(90deg,var(--barok),#6ae0b0)}
    .bar .label{font-size:12px; margin-bottom:8px; color:var(--muted)}

    .buttons{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .btn{border:1px solid #24324e; background:#0f1730; color:var(--text); border-radius:12px; padding:12px; text-align:center; cursor:pointer; user-select:none}
    .btn:hover{background:#122042}
    .btn.primary{background:linear-gradient(180deg,#204a9a,#163770); border-color:#274b8c}
    .btn.warn{background:linear-gradient(180deg,#9a6a20,#704e16); border-color:#8c5d27}

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:999}
    .modal.open{display:flex}
    .sheet{width:min(92vw,720px); max-height:92vh; overflow:auto; padding:16px; border-radius:16px}
    .sheet h3{margin:0 0 10px}
    .close-x{position: sticky; top:0; float:right; background:#182238; border:1px solid #2d3d60; color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer}
    .grid2{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .item{border:1px solid #2a3b59; border-radius:12px; padding:10px; background:#0e1529}
    .item h4{margin:0 0 6px; font-size:15px}
    .item .muted{font-size:12px}
    .price{margin-top:8px; font-weight:600}
    .tiny{font-size:12px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2b3c59; background:#0e162a}
    .admin{border:1px dashed #5d7ab5; padding:10px; border-radius:12px; background:#0c1831}

    /* –º–∏–Ω–∏-–∏–≥—Ä–∞ */
    .minigame-box{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
    .score{font-size:24px; font-weight:700}
    .tap{width:160px; height:160px; border-radius:999px; border:none; background:radial-gradient(circle at 30% 30%, #8ad0ff, #3578d8); color:white; font-size:18px; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .tap:active{transform:scale(.98)}

    a{color:var(--link); text-decoration:none}
    .hr{height:1px; background:#24324e; margin:10px 0}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">üêπ Tamagocho</div>
      <div class="row">
        <span class="badge">Seeds: <b id="seeds">0</b></span>
        <span class="badge">Coins: <b id="coins">0</b></span>
        <span class="badge">Level: <b id="level">1</b></span>
      </div>
    </div>

    <div class="card viewport">
      <canvas id="webgl" class="webgl"></canvas>
    </div>

    <div class="stats">
      <div class="bar">
        <div class="label">–°—ã—Ç–æ—Å—Ç—å <span class="right"><b id="hungerNum">0</b>%</span></div>
        <div id="hungerBar" style="width:0%"></div>
      </div>
      <div class="bar">
        <div class="label">–ë–æ–¥—Ä–æ—Å—Ç—å <span class="right"><b id="energyNum">0</b>%</span></div>
        <div id="energyBar" style="width:0%"></div>
      </div>
      <div class="bar">
        <div class="label">–í–µ—Å–µ–ª—å–µ <span class="right"><b id="funNum">0</b>%</span></div>
        <div id="funBar" style="width:0%"></div>
      </div>
    </div>

    <div class="buttons">
      <div class="btn primary" id="btnFeed">–ü–æ–∫–æ—Ä–º–∏—Ç—å</div>
      <div class="btn" id="btnPlay">–ú–∏–Ω–∏-–∏–≥—Ä–∞</div>
      <div class="btn" id="btnSleep">–£–ª–æ–∂–∏—Ç—å —Å–ø–∞—Ç—å</div>

      <div class="btn" id="btnShop">–ú–∞–≥–∞–∑–∏–Ω</div>
      <div class="btn" id="btnQuests">–ö–≤–µ—Å—Ç—ã</div>
      <div class="btn" id="btnInv">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>

      <div class="btn" id="btnHall">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
      <div class="btn" id="btnSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="btn warn" id="btnAdmin" style="display:none">–ê–¥–º–∏–Ω</div>
    </div>

    <div class="muted tiny" style="margin-top:8px">
      –°–æ–≤–µ—Ç—ã: –∑–∞ –∫–≤–µ—Å—Ç—ã –≤—ã–¥–∞—é—Ç—Å—è <b>Coins</b>. ¬´Seeds¬ª ‚Äî –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–∞—è –º—è–≥–∫–∞—è –≤–∞–ª—é—Ç–∞ (–∑–∞ –º–∏–Ω–∏-–∏–≥—Ä—É / –µ–∂–µ–¥–Ω–µ–≤–∫—É).
      –ü—Ä–µ–º–∏—É–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π (–∫–æ–¥ —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω).
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∏ -->
  <div class="modal" id="modalShop">
    <div class="sheet card">
      <button class="close-x" data-close="modalShop">‚úï</button>
      <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
      <div class="grid3" id="shopList"></div>
      <div class="hr"></div>
      <div class="tiny muted">–ü—Ä–µ–º–∏—É–º-–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π.</div>
    </div>
  </div>

  <div class="modal" id="modalInv">
    <div class="sheet card">
      <button class="close-x" data-close="modalInv">‚úï</button>
      <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
      <div class="grid3" id="invList"></div>
    </div>
  </div>

  <div class="modal" id="modalQuests">
    <div class="sheet card">
      <button class="close-x" data-close="modalQuests">‚úï</button>
      <h3>üß≠ –ö–≤–µ—Å—Ç—ã</h3>
      <div id="questList" class="grid2"></div>
    </div>
  </div>

  <div class="modal" id="modalHall">
    <div class="sheet card">
      <button class="close-x" data-close="modalHall">‚úï</button>
      <h3>üèÜ –õ–∏–¥–µ—Ä—ã</h3>
      <div id="hallLocal" class="item">
        <h4>–õ–æ–∫–∞–ª—å–Ω—ã–π</h4>
        <ol id="hallLocalList" class="tiny"></ol>
      </div>
      <div class="hr"></div>
      <div id="hallGlobal" class="item">
        <h4>–ì–ª–æ–±–∞–ª—å–Ω—ã–π</h4>
        <div class="tiny muted" id="hallGlobalInfo">–í–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ —É–∫–∞–∂–µ–º BACKEND_URL.</div>
        <ol id="hallGlobalList" class="tiny"></ol>
      </div>
    </div>
  </div>

  <div class="modal" id="modalGame">
    <div class="sheet card">
      <button class="close-x" data-close="modalGame">‚úï</button>
      <h3>üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞: Tap-Rush</h3>
      <div class="minigame-box">
        <div class="score">–û—á–∫–∏: <span id="mgScore">0</span></div>
        <button class="tap" id="mgTap">Tap!</button>
        <div class="tiny muted" style="width:100%; text-align:center">
          –ò–≥—Ä–∞ –∏–¥—ë—Ç 15 —Å–µ–∫. 1 –æ—á–∫–æ = +1 Seeds. –†–µ–∫–æ—Ä–¥ –∑–∞–Ω–æ—Å–∏—Ç—Å—è –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥.
        </div>
        <div class="row" style="gap:8px">
          <div class="btn" id="mgStart">–°—Ç–∞—Ä—Ç</div>
          <div class="btn" id="mgStop">–°—Ç–æ–ø</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSettings">
    <div class="sheet card">
      <button class="close-x" data-close="modalSettings">‚úï</button>
      <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="grid2">
        <div class="item">
          <h4>–§–æ–Ω</h4>
          <div class="row">
            <div class="btn tiny" data-bg="dark">–¢—ë–º–Ω—ã–π</div>
            <div class="btn tiny" data-bg="blue">–°–∏–Ω–∏–π</div>
          </div>
        </div>
        <div class="item">
          <h4>–°–±—Ä–æ—Å (–ª–æ–∫–∞–ª—å–Ω–æ)</h4>
          <div class="btn tiny" id="btnWipe">–°—Ç–µ—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="tiny muted">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±—ç–∫–µ–Ω–¥–∞.</div>
    </div>
  </div>

  <div class="modal" id="modalAdmin">
    <div class="sheet card">
      <button class="close-x" data-close="modalAdmin">‚úï</button>
      <h3>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Å–æ–∑–¥–∞—Ç–µ–ª—å)</h3>
      <div class="admin">
        <div class="row" style="gap:6px; flex-wrap:wrap">
          <div class="btn tiny" data-admin="giveSeeds">+500 Seeds</div>
          <div class="btn tiny" data-admin="giveCoins">+200 Coins</div>
          <div class="btn tiny" data-admin="fillStats">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—ã</div>
          <div class="btn tiny" data-admin="giveItems">–í—ã–¥–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
        </div>
        <div class="tiny muted" style="margin-top:8px">
          –≠—Ç–∞ –ø–∞–Ω–µ–ª—å –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –∏–≥—Ä—ã (ID 1907547038). –î–µ–π—Å—Ç–≤–∏—è –Ω–µ —è–≤–ª—è—é—Ç—Å—è –¥–æ–Ω–∞—Ç–æ–º –∏ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
========================= */
const OWNER_ID = 1907547038; // —Ç–≤–æ–π Telegram ID
// ‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–∞ .glb –∫–∞–∫ —Å–µ–π—á–∞—Å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (—Å –ø—Ä–æ–±–µ–ª–æ–º/—Å–∫–æ–±–∫–∞–º–∏).
// –õ—É—á—à–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª –≤ hamster.glb –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É.
const HAMSTER_URL = "https://daniil1488nsdap-ctrl.github.io/tamagocho-webapp/hamster.glb";
// –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –±—ç–∫–µ–Ω–¥ ‚Äî –≤–ø–∏—Å–∞—Ç—å —Å—é–¥–∞ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–≤–æ–π Render)
const BACKEND_URL = ""; // –ø—Ä–∏–º–µ—Ä: "https://tamagocho-backend.onrender.com"

/* =========================
   –í—Å–ø–æ–º–æ–≥–∞–ª–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
========================= */
const tg = window.Telegram?.WebApp;
tg?.expand();

const state = {
  user: null,
  stats: { hunger: 70, energy: 80, fun: 60, level:1, exp:0 },
  wallet: { seeds: 50, coins: 10 },
  record: 0,
  inventory: [],
  accessories: [], // –¥–ª—è 3D (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
  lastTick: Date.now()
};

function save(){
  localStorage.setItem("tg_tamagocho", JSON.stringify({
    stats: state.stats, wallet: state.wallet, record: state.record, inventory: state.inventory
  }));
}
function load(){
  const raw = localStorage.getItem("tg_tamagocho");
  if(raw){
    try{
      const d = JSON.parse(raw);
      Object.assign(state.stats, d.stats||{});
      Object.assign(state.wallet, d.wallet||{});
      state.record = d.record||0;
      state.inventory = d.inventory||[];
    }catch(e){}
  }
}
load();

function $(sel){ return document.querySelector(sel); }
function $all(sel){ return [...document.querySelectorAll(sel)]; }
function openModal(id){ $('#'+id).classList.add('open'); }
function closeModal(id){ $('#'+id).classList.remove('open'); }

/* =========================
   UI –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–æ–≤
========================= */
function clamp(n, a=0, b=100){ return Math.max(a, Math.min(b, n)); }
function render(){
  $('#seeds').textContent = state.wallet.seeds|0;
  $('#coins').textContent = state.wallet.coins|0;
  $('#level').textContent = state.stats.level|0;

  const H = clamp(state.stats.hunger);
  const E = clamp(state.stats.energy);
  const F = clamp(state.stats.fun);

  $('#hungerNum').textContent = H;
  $('#energyNum').textContent = E;
  $('#funNum').textContent    = F;

  $('#hungerBar').style.width = H+'%';
  $('#energyBar').style.width = E+'%';
  $('#funBar').style.width    = F+'%';
}
render();

/* –ü–∞—Å—Å–∏–≤–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ */
setInterval(()=>{
  const now = Date.now();
  const dt = (now - state.lastTick)/1000;
  state.lastTick = now;
  if(dt>0){
    state.stats.hunger = clamp(state.stats.hunger - 0.01*dt);
    state.stats.energy = clamp(state.stats.energy - 0.008*dt);
    state.stats.fun    = clamp(state.stats.fun    - 0.012*dt);
    render(); save();
  }
}, 1500);

/* –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (–ø–æ —Ä–µ–∫–æ—Ä–¥—É –º–∏–Ω–∏-–∏–≥—Ä—ã) */
function updateLocalHall(){
  const key="tg_tamagocho_local_hall";
  const userName = state.user?.username || state.user?.first_name || "You";
  let arr = JSON.parse(localStorage.getItem(key) || "[]");
  const me = {name:userName, score: state.record|0};
  arr = arr.filter(x=>x.name!==me.name).concat([me]).sort((a,b)=>b.score-a.score).slice(0,20);
  localStorage.setItem(key, JSON.stringify(arr));
  const ol = $('#hallLocalList'); ol.innerHTML='';
  arr.forEach(x=>{
    const li=document.createElement('li'); li.textContent=`${x.name} ‚Äî ${x.score}`;
    ol.appendChild(li);
  });
}

/* –ó–∞–≥–ª—É—à–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
async function updateGlobalHall(){
  const ol = $('#hallGlobalList'); ol.innerHTML='';
  if(!BACKEND_URL){ $('#hallGlobalInfo').style.display='block'; return; }
  $('#hallGlobalInfo').style.display='none';
  try{
    const r = await fetch(BACKEND_URL+'/hall'); // –æ–∂–∏–¥–∞–µ–º—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
    const arr = await r.json();
    arr.slice(0,20).forEach(x=>{
      const li=document.createElement('li'); li.textContent=`${x.name} ‚Äî ${x.score}`;
      ol.appendChild(li);
    });
  }catch(e){
    const li=document.createElement('li'); li.textContent='–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    ol.appendChild(li);
  }
}

/* =========================
   –ú–∞–≥–∞–∑–∏–Ω / –ø—Ä–µ–¥–º–µ—Ç—ã
========================= */
const SHOP_ITEMS = [
  { id:'food_small',  name:'–Ø–≥–æ–¥–∞',  type:'food',  effect:{hunger:+25}, price: {coins:5},  desc:'–ü–ª—é—Å —Å—ã—Ç–æ—Å—Ç—å' },
  { id:'toy_ball',    name:'–ú—è—á',    type:'toy',   effect:{fun:+25},    price: {coins:6},  desc:'–ü–ª—é—Å –≤–µ—Å–µ–ª—å–µ' },
  { id:'bed_pillow',  name:'–ü–æ–¥—É—à–∫–∞',type:'sleep', effect:{energy:+25}, price: {coins:7},  desc:'–ü–ª—é—Å –±–æ–¥—Ä–æ—Å—Ç—å' },
  // –ø—Ä–µ–º–∏—É–º –∑–∞–≥–ª—É—à–∫–∏ (–ø–æ–∫–∞–∂–µ–º, –Ω–æ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏)
  { id:'acc_hat',     name:'–®–ª—è–ø–∞',  type:'acc',   premium:true, desc:'–ê–∫—Å–µ—Å—Å—É–∞—Ä (–ø—Ä–µ–º–∏—É–º)' },
  { id:'acc_bow',     name:'–ë–∞–Ω—Ç–∏–∫', type:'acc',   premium:true, desc:'–ê–∫—Å–µ—Å—Å—É–∞—Ä (–ø—Ä–µ–º–∏—É–º)' }
];

function drawShop(){
  const root = $('#shopList'); root.innerHTML='';
  SHOP_ITEMS.forEach(it=>{
    const div=document.createElement('div'); div.className='item';
    const p = it.price?.coins? `${it.price.coins} Coins` : (it.premium?'–ü—Ä–µ–º–∏—É–º':'‚Äî');
    div.innerHTML = `
      <h4>${it.name}</h4>
      <div class="muted tiny">${it.desc||''}</div>
      <div class="price">${p}</div>
      <div class="row" style="margin-top:8px">
        ${it.premium? `<div class="btn tiny" data-buy="${it.id}">–ö—É–ø–∏—Ç—å (off)</div>` :
                      `<div class="btn tiny" data-buy="${it.id}">–ö—É–ø–∏—Ç—å</div>`}
      </div>
    `;
    root.appendChild(div);
  });
}
function drawInventory(){
  const root = $('#invList'); root.innerHTML='';
  if(!state.inventory.length){
    root.innerHTML = `<div class="muted tiny">–ü—É—Å—Ç–æ. –ö—É–ø–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ.</div>`; return;
  }
  state.inventory.forEach((it,idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `
      <h4>${it.name}</h4>
      <div class="muted tiny">${it.type==='acc'?'–ê–∫—Å–µ—Å—Å—É–∞—Ä':'–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç'}</div>
      <div class="row" style="margin-top:8px">
        ${it.type==='acc'? `<div class="btn tiny" data-equip="${idx}">–ù–∞–¥–µ—Ç—å</div>` :
                           `<div class="btn tiny" data-use="${idx}">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</div>`}
        <div class="btn tiny" data-drop="${idx}">–£–¥–∞–ª–∏—Ç—å</div>
      </div>
    `;
    root.appendChild(div);
  });
}

/* –ü–æ–∫—É–ø–∫–∞/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ */
document.addEventListener('click', (e)=>{
  const buy = e.target.closest('[data-buy]');
  if(buy){
    const id = buy.dataset.buy;
    const it = SHOP_ITEMS.find(x=>x.id===id);
    if(!it) return;
    if(it.premium){
      tg?.showPopup({title:"–ü—Ä–µ–º–∏—É–º", message:"–û–ø–ª–∞—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ (–ÆKassa/Stars).", buttons:[{type:'ok'}]});
      return;
    }
    const cost = it.price?.coins|0;
    if(state.wallet.coins < cost){
      tg?.showPopup?.({title:"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Coins", message:"–í—ã–ø–æ–ª–Ω—è–π –∫–≤–µ—Å—Ç—ã –∏ –∏–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—É!", buttons:[{type:'ok'}]});
      return;
    }
    state.wallet.coins -= cost;
    state.inventory.push({id:it.id, name:it.name, type:it.type, effect:it.effect});
    render(); drawInventory(); save();
  }
  const use = e.target.closest('[data-use]');
  if(use){
    const i = +use.dataset.use;
    const it = state.inventory[i]; if(!it) return;
    // –ø—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç
    if(it.effect?.hunger) state.stats.hunger = clamp(state.stats.hunger + it.effect.hunger);
    if(it.effect?.energy) state.stats.energy = clamp(state.stats.energy + it.effect.energy);
    if(it.effect?.fun)    state.stats.fun    = clamp(state.stats.fun    + it.effect.fun);
    // –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π ‚Äî —É–¥–∞–ª—è–µ–º
    state.inventory.splice(i,1);
    render(); drawInventory(); save();
  }
  const eq = e.target.closest('[data-equip]');
  if(eq){
    const i = +eq.dataset.equip;
    const it = state.inventory[i];
    if(it?.type==='acc'){
      // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ; –≤ –±—É–¥—É—â–µ–º ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ 3D-–º–µ—à–∞
      tg?.showPopup?.({title:"–ê–∫—Å–µ—Å—Å—É–∞—Ä", message:`${it.name} –Ω–∞–¥–µ—Ç (–≤–∏–∑—É–∞–ª –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ).`, buttons:[{type:'ok'}]});
    }
  }
  const drop = e.target.closest('[data-drop]');
  if(drop){
    const i = +drop.dataset.drop;
    state.inventory.splice(i,1); drawInventory(); save();
  }
});

/* =========================
   –ö–≤–µ—Å—Ç—ã
========================= */
const QUESTS = [
  { id:'daily_login', name:'–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥',   prize:{coins:5},  cooldown: 24*3600, last:0 },
  { id:'pet_care',    name:'–£—Ö–æ–¥ –∑–∞ –ø–∏—Ç–æ–º—Ü–µ–º',  prize:{coins:6},  cond:()=>state.stats.hunger>80 },
  { id:'mini10',      name:'–ù–∞–±—Ä–∞—Ç—å 10 –æ—á–∫–æ–≤',  prize:{coins:7},  cond:()=>state.record>=10 },
];

function drawQuests(){
  const root=$('#questList'); root.innerHTML='';
  const now=Date.now()/1000|0;
  QUESTS.forEach(q=>{
    const canByCooldown = q.cooldown? (now-(q.last||0) >= q.cooldown) : true;
    const ok = (q.cond? q.cond(): true) && canByCooldown;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `
      <h4>${q.name}</h4>
      <div class="muted tiny">–ù–∞–≥—Ä–∞–¥–∞: ${q.prize.coins|0} Coins</div>
      <div class="row" style="margin-top:8px">
        <div class="btn tiny" data-claim="${q.id}" ${ok?'':'style="opacity:.5;pointer-events:none"'}>–ó–∞–±—Ä–∞—Ç—å</div>
      </div>
    `;
    root.appendChild(div);
  });
}
document.addEventListener('click',(e)=>{
  const claim = e.target.closest('[data-claim]');
  if(claim){
    const id=claim.dataset.claim;
    const q = QUESTS.find(x=>x.id===id); if(!q) return;
    const now=Date.now()/1000|0;
    const canByCooldown = q.cooldown? (now-(q.last||0) >= q.cooldown) : true;
    if(q.cond && !q.cond()) return;
    if(!canByCooldown) return;
    state.wallet.coins += (q.prize.coins|0);
    q.last = now;
    render(); drawQuests(); save();
  }
});

/* =========================
   –ú–∏–Ω–∏-–∏–≥—Ä–∞ Tap-Rush
========================= */
let mgTimer=null, mgRemain=0, mgScore=0;

function mgReset(){
  clearInterval(mgTimer); mgTimer=null;
  mgRemain=0; mgScore=0; $('#mgScore').textContent='0';
}
$('#mgTap').addEventListener('click', ()=>{
  if(!mgTimer) return;
  mgScore++; $('#mgScore').textContent=mgScore;
});
$('#mgStart').addEventListener('click', ()=>{
  mgReset(); mgRemain=15;
  mgTimer=setInterval(()=>{
    mgRemain--;
    if(mgRemain<=0){
      clearInterval(mgTimer); mgTimer=null;
      // –Ω–∞–≥—Ä–∞–¥–∞
      state.wallet.seeds += mgScore;
      state.record = Math.max(state.record, mgScore);
      updateLocalHall(); render(); save();
      tg?.showPopup?.({title:"–ò—Ç–æ–≥", message:`–û—á–∫–∏: ${mgScore}\n+${mgScore} Seeds`, buttons:[{type:'ok'}]});
    }
  }, 1000);
});
$('#mgStop').addEventListener('click', ()=> mgReset());

/* =========================
   –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
========================= */
$('#btnFeed').addEventListener('click', ()=>{
  state.stats.hunger = clamp(state.stats.hunger + 15);
  render(); save();
});
$('#btnSleep').addEventListener('click', ()=>{
  state.stats.energy = clamp(state.stats.energy + 18);
  render(); save();
});
$('#btnPlay').addEventListener('click', ()=>{ mgReset(); openModal('modalGame'); });

$('#btnShop').addEventListener('click', ()=>{ drawShop(); openModal('modalShop'); });
$('#btnInv').addEventListener('click', ()=>{ drawInventory(); openModal('modalInv'); });
$('#btnQuests').addEventListener('click', ()=>{ drawQuests(); openModal('modalQuests'); });
$('#btnHall').addEventListener('click', ()=>{ updateLocalHall(); updateGlobalHall(); openModal('modalHall'); });
$('#btnSettings').addEventListener('click', ()=> openModal('modalSettings'));

$all('.close-x').forEach(b=> b.addEventListener('click', e=>{
  const id=b.dataset.close; if(id) closeModal(id);
}));

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
document.addEventListener('click',(e)=>{
  const bg = e.target.closest('[data-bg]');
  if(bg){
    const v=bg.dataset.bg;
    if(v==='dark'){ document.documentElement.style.setProperty('--bg','#0f1620'); }
    if(v==='blue'){ document.documentElement.style.setProperty('--bg','#0e1530'); }
  }
});
$('#btnWipe').addEventListener('click', ()=>{
  localStorage.removeItem('tg_tamagocho');
  location.reload();
});

/* =========================
   –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
========================= */
function getUserFromTG(){
  // –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ initDataUnsafe (–≤ –≤–µ–±-–ø—Ä–µ–≤—å—é –º–æ–∂–µ—Ç –±—ã—Ç—å undefined)
  let u = tg?.initDataUnsafe?.user;
  if(u) return u;
  // fallback (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞)
  return { id: OWNER_ID, first_name:'Owner', username:'owner' };
}
state.user = getUserFromTG();
if(state.user?.id === OWNER_ID){ $('#btnAdmin').style.display='block'; }
$('#btnAdmin').addEventListener('click', ()=> openModal('modalAdmin'));

document.addEventListener('click',(e)=>{
  const adm = e.target.closest('[data-admin]');
  if(!adm) return;
  if(state.user?.id !== OWNER_ID) return;
  const a = adm.dataset.admin;
  if(a==='giveSeeds') state.wallet.seeds += 500;
  if(a==='giveCoins') state.wallet.coins += 200;
  if(a==='fillStats'){ state.stats.hunger=100; state.stats.energy=100; state.stats.fun=100; }
  if(a==='giveItems'){
    state.inventory.push(
      {id:'acc_hat', name:'–®–ª—è–ø–∞', type:'acc'},
      {id:'acc_bow', name:'–ë–∞–Ω—Ç–∏–∫', type:'acc'},
      {id:'food_small', name:'–Ø–≥–æ–¥–∞', type:'food', effect:{hunger:+25}}
    );
  }
  render(); save(); drawInventory();
});

/* =========================
   3D-–ü–∏—Ç–æ–º–µ—Ü (three.js)
========================= */
let renderer, scene, camera, controls, mixer=null, clock=new THREE.Clock();
const canvas = document.getElementById('webgl');

function init3D(){
  const w = canvas.clientWidth || canvas.parentElement.clientWidth;
  const h = canvas.clientHeight|| 420;

  renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  renderer.setSize(w,h,false);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));

  scene = new THREE.Scene();
  scene.background = null; // –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π

  camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 100);
  camera.position.set(0,1.1,2.2);
  scene.add(camera);

  const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 1.0);
  scene.add(hemi);

  const dir = new THREE.DirectionalLight(0xffffff, 0.9);
  dir.position.set(2,3,2);
  scene.add(dir);

  controls = new THREE.OrbitControls(camera, canvas);
  controls.enablePan=false;
  controls.enableDamping=true;
  controls.minDistance=1.2; controls.maxDistance=3.0;
  controls.target.set(0,0.7,0);

  // –ø–ª–æ—â–∞–¥–∫–∞
  const g = new THREE.CircleGeometry(1.1, 48);
  const m = new THREE.MeshStandardMaterial({color:0x1a253a, roughness:.9, metalness:.0});
  const plate = new THREE.Mesh(g,m);
  plate.rotation.x = -Math.PI/2; plate.position.y = 0;
  plate.receiveShadow = true; scene.add(plate);

  // –∑–∞–≥—Ä—É–∑–∫–∞ GLB
  const loader = new THREE.GLTFLoader();
  loader.load(HAMSTER_URL, (glb)=>{
    const root = glb.scene;
    root.position.set(0,0,0);
    root.traverse(o=>{
      if(o.isMesh){ o.castShadow=true; o.receiveShadow=true; }
    });
    scene.add(root);
    // –∞–Ω–∏–º–∞—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
    if(glb.animations?.length){
      mixer = new THREE.AnimationMixer(root);
      const clip = glb.animations[0];
      const act = mixer.clipAction(clip);
      act.play();
    }
  }, undefined, (err)=>{
    console.warn("GLB load error", err);
  });

  animate();
}
function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  mixer?.update(dt);
  controls.update();
  renderer.render(scene, camera);
}
function onResize(){
  if(!renderer) return;
  const w = canvas.clientWidth || canvas.parentElement.clientWidth;
  const h = canvas.clientHeight || 420;
  camera.aspect = w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h,false);
}
window.addEventListener('resize', onResize);
init3D();

/* –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã */
render(); updateLocalHall();

</script>
</body>
</html>
