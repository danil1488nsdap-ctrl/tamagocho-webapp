<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamagocho</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#0f1620;--card:#151e2e;--text:#e6eef8;--muted:#9bb2d0;
  --ok:#34d399;--warn:#f59e0b;--accent:#80d8ee;
  --red:#ef4444;--green:#22c55e;--blue:#3b82f6;--violet:#8b5cf6;
}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:420px;margin:0 auto;padding:16px 16px 80px}
.card{background:var(--card);border-radius:16px;padding:14px 14px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
.row{display:flex;gap:10px}
.header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.avatar{width:54px;height:54px;border-radius:50%;object-fit:cover;border:2px solid #0003}
h1{font-size:20px;margin:0}
.muted{color:var(--muted);font-size:13px}
.pet-box{display:flex;flex-direction:column;align-items:center;padding:12px 0 6px}
.pet{width:260px;height:260px;border-radius:24px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.4);transition:transform .2s}
.pet.smile{transform:scale(1.01)}
.bars{display:flex;gap:8px;margin-top:10px}
.bar{flex:1;height:9px;background:#0e1220;border-radius:999px;overflow:hidden}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,#07c98b,#8be9c7)}
.progress{display:flex;gap:10px;justify-content:space-between;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #ffffff14;background:#ffffff0f;color:var(--text);cursor:pointer}
.btn.ok{background:#10b9811a;border-color:#10b98140}
.btn.warn{background:#f59f0b1a;border-color:#f59f0b40}
.btn.primary{background:#3b82f622;border-color:#3b82f677}
.btn.full{width:100%}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{padding:4px 8px;background:#00000033;border:1px solid #ffffff1c;border-radius:999px;font-size:12px}
.kv{display:flex;justify-content:space-between;margin:4px 0;color:var(--muted);font-size:13px}
.section-title{margin:16px 0 8px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.hidden{display:none !important}
hr{border:0;height:1px;background:#ffffff14;margin:14px 0}

/* –º–æ–¥–∞–ª–∫–∏ */
.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
.modal.show{display:flex}
.sheet{width:100%;max-width:480px;background:var(--card);border-radius:16px;padding:14px}

.list{display:flex;flex-direction:column;gap:8px}
.item{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px dashed #ffffff2a;border-radius:12px}
.item>div{display:flex;align-items:center;gap:10px}
.price{color:#ffd876}
.tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #ffffff24}
.row-wrap{display:flex;flex-wrap:wrap;gap:8px}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:6px 8px;border-radius:999px;background:#ffffff10;border:1px solid #ffffff20;font-size:12px;cursor:pointer}
.chip.active{outline:2px solid var(--accent);background:#2a4155}

/* —ç–º–æ—Ü–∏–∏ */
.fx{position:absolute;pointer-events:none}
.emoji{position:absolute;font-size:28px;animation:float 1.2s ease-out forwards}
@keyframes float{from{transform:translateY(0);opacity:.9}to{transform:translateY(-60px);opacity:0}}
.pet-stage-1{filter:saturate(1)}
.pet-stage-2{filter:saturate(1.1) drop-shadow(0 0 8px #ffc76a40)}
.pet-stage-3{filter:saturate(1.2) drop-shadow(0 0 12px #ffd76a60)}
.room{background-size:cover;background-position:center;border-radius:16px}

/* –º–∏–Ω–∏-–∏–≥—Ä–∞ */
#gameRun .track{height:18px;background:#0c1320;border-radius:999px;overflow:hidden;margin:8px 0}
#gameRun .track>i{display:block;height:100%;background:linear-gradient(90deg,#5eead4,#22c55e);width:0%}
.timer{font-family:monospace}

/* –∞–¥–º–∏–Ω */
.admin-pill{background:#ffd87622;border:1px solid #ffd87666;color:#ffd876;padding:2px 8px;border-radius:8px;font-size:12px}

</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="card header">
    <img id="avatar" class="avatar" src="https://i.pravatar.cc/100" alt="">
    <div style="flex:1">
      <h1 style="display:flex;align-items:center;gap:8px">
        Tamagocho <span id="isAdmin" class="admin-pill hidden">ADMIN</span>
      </h1>
      <div class="muted" id="hello">–ü—Ä–∏–≤–µ—Ç!</div>
    </div>
    <div class="row">
      <button class="btn" id="btnSettings">‚öôÔ∏è</button>
      <button class="btn" id="btnShop">üõí</button>
    </div>
  </div>

  <!-- –ö–æ–º–Ω–∞—Ç–∞ / –ü–∏—Ç–æ–º–µ—Ü -->
  <div id="room" class="card room">
    <div class="pet-box" style="position:relative">
      <img id="pet" class="pet pet-stage-1" src="./pet.webp" alt="–ü–∏—Ç–æ–º–µ—Ü">
      <div id="fx" class="fx" style="inset:0;"></div>
      <div class="chips" id="reactionBar" style="margin-top:8px">
        <span class="chip" data-emo="‚ù§Ô∏è">‚ù§Ô∏è</span>
        <span class="chip" data-emo="üòÇ">üòÇ</span>
        <span class="chip" data-emo="üëè">üëè</span>
        <span class="chip" data-emo="‚ú®">‚ú®</span>
      </div>
    </div>
    <div class="bars">
      <div class="bar"><i id="bH"></i></div>
      <div class="bar"><i id="bE"></i></div>
      <div class="bar"><i id="bC"></i></div>
    </div>
    <div class="progress small">
      <span>–°—á–∞—Å—Ç—å–µ</span><span id="statsText"></span>
    </div>
    <div class="grid" style="margin-top:10px">
      <button class="btn ok" id="btnFeed">üçé –ö–æ—Ä–º–∏—Ç—å</button>
      <button class="btn ok" id="btnSleep">üò¥ –°–ø–∞—Ç—å</button>
      <button class="btn primary" id="btnPlay">üé≤ –ú–∏–Ω–∏-–∏–≥—Ä–∞</button>
      <button class="btn warn" id="btnQuest">üìã –ö–≤–µ—Å—Ç—ã</button>
    </div>
    <div class="kv"><span>–ú–æ–Ω–µ—Ç—ã (Seeds)</span><b id="coins">0</b></div>
    <div class="kv"><span>–£—Ä–æ–≤–µ–Ω—å</span><b id="level">1</b></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnChest">üéÅ –°—É–Ω–¥—É–∫</button>
      <button class="btn" id="btnAch">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button class="btn" id="btnLB">üìä –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
    </div>
    <div class="small" id="weeklyNote" style="margin-top:6px;color:#ffd876"></div>
  </div>

  <!-- –ú–∞–≥–∞–∑–∏–Ω -->
  <div class="card" style="margin-top:10px">
    <div class="section-title">–ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="chips" id="shopTabs">
      <span class="chip active" data-tab="items">–ü—Ä–µ–¥–º–µ—Ç—ã</span>
      <span class="chip" data-tab="interiors">–ò–Ω—Ç–µ—Ä—å–µ—Ä—ã</span>
      <span class="chip" data-tab="premium">–ü—Ä–µ–º–∏—É–º</span>
    </div>
    <div id="shopList" class="list" style="margin-top:8px"></div>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div class="card" style="margin-top:10px">
    <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="row-wrap">
      <button class="btn" id="btnSnapshot">üì§ –≠–∫—Å–ø–æ—Ä—Ç –ø–∏—Ç–æ–º—Ü–∞</button>
      <button class="btn" id="btnVisit">üëÄ –í–∏–∑–∏—Ç –∫ –¥—Ä—É–≥—É</button>
      <button class="btn" id="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn" id="btnReset">üóë –°–±—Ä–æ—Å</button>
    </div>
    <div id="devPanel" class="hidden" style="margin-top:10px">
      <hr>
      <div class="section-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
      <div class="row-wrap">
        <button class="btn" id="devCoins">+1000 Seeds</button>
        <button class="btn" id="devAcc">–í—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
        <button class="btn" id="devMax">MAX —Å—Ç–∞—Ç—ã</button>
      </div>
    </div>
  </div>

</div>

<!-- –ú–æ–¥–∞–ª–∫–∏ -->
<div id="modalShop" class="modal"><div class="sheet">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>–ú–∞–≥–∞–∑–∏–Ω</b><button class="btn" data-close>‚úñ</button>
  </div><div id="mShop" class="list" style="margin-top:8px"></div>
</div></div>

<div id="modalLB" class="modal"><div class="sheet">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</b><button class="btn" data-close>‚úñ</button>
  </div>
  <div class="small" id="lbInfo" style="margin:8px 0"></div>
  <div class="row" style="gap:8px;margin:8px 0">
    <button class="btn" id="syncLocal">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π</button>
    <button class="btn" id="pushGlobal">‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π</button>
    <button class="btn" id="pullGlobal">‚¨áÔ∏è –¢–æ–ø –≥–ª–æ–±–∞–ª—å–Ω—ã–π</button>
  </div>
  <div class="section-title">–õ–æ–∫–∞–ª—å–Ω—ã–π</div>
  <div id="lbLocal" class="list"></div>
  <hr>
  <div class="section-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</div>
  <div id="lbGlobal" class="list small"></div>
</div></div>

<div id="modalQuests" class="modal"><div class="sheet">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</b><button class="btn" data-close>‚úñ</button>
  </div>
  <div class="small">–°–±—Ä–æ—Å —á–µ—Ä–µ–∑: <span id="questLeft" class="timer">--:--:--</span></div>
  <div id="questList" class="list" style="margin-top:8px"></div>
</div></div>

<div id="modalAch" class="modal"><div class="sheet">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</b><button class="btn" data-close>‚úñ</button>
  </div>
  <div id="achList" class="list" style="margin-top:8px"></div>
</div></div>

<div id="modalRun" class="modal"><div class="sheet" id="gameRun">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>üèÉ –ë–µ–≥ –•–æ–º—è–∫–∞</b><button class="btn" data-close>‚úñ</button>
  </div>
  <div class="small">–¢–∞–ø–∞–π –∫–∞–∫ –º–æ–∂–Ω–æ —á–∞—â–µ –∑–∞ 10 —Å–µ–∫—É–Ω–¥!</div>
  <div class="track"><i id="runBar"></i></div>
  <div class="row" style="gap:8px">
    <button class="btn primary full" id="runStart">–°—Ç–∞—Ä—Ç</button>
    <span class="timer" id="runTime">10.0</span>
  </div>
  <div class="kv"><span>–û—á–∫–æ–≤</span><b id="runScore">0</b></div>
</div></div>

<div id="modalVisit" class="modal"><div class="sheet">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>–í–∏–∑–∏—Ç –∫ –¥—Ä—É–≥—É</b><button class="btn" data-close>‚úñ</button>
  </div>
  <div class="small">–î—Ä—É–≥ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–≤–æ–π ¬´—Å–Ω–∞–ø—à–æ—Ç-–∫–æ–¥¬ª (—Ç–µ–∫—Å—Ç). –í—Å—Ç–∞–≤—å –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞.</div>
  <textarea id="visitCode" rows="5" style="width:100%;margin-top:8px"></textarea>
  <div class="row" style="margin-top:8px">
    <button class="btn primary" id="visitPreview">–û—Ç–∫—Ä—ã—Ç—å</button>
    <button class="btn" id="visitGiveHeart">‚ù§Ô∏è –ü–æ–¥–∞—Ä–∏—Ç—å —Å–µ—Ä–¥–µ—á–∫–æ</button>
  </div>
  <div id="visitState" class="small" style="margin-top:8px;color:#ffd876"></div>
</div></div>

<script>
/* ========== –ö–û–ù–°–¢–ê–ù–¢–´ ========== */
const OWNER_ID = 1907547038;       // —Ç–æ–ª—å–∫–æ —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ ‚Äî –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
const BACKEND_URL = "";            // —É–∫–∞–∂–µ—à—å –ø–æ–∑–∂–µ ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥
const CHEST_COOLDOWN_MS = 4*60*60*1000;  // 4 —á–∞—Å–∞
const WEEKLY_DAYS_GOAL = 3;        // —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å—á–∞—Å—Ç—å–µ ‚â•90 –¥–ª—è –Ω–∞–≥—Ä–∞–¥—ã

/* ========== –£–¢–ò–õ–° ========== */
const $=sel=>document.querySelector(sel);
const $$=sel=>document.querySelectorAll(sel);
const now=()=>Date.now();
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const fmt=(n)=>new Intl.NumberFormat('ru-RU').format(n);
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??d;}catch{ return d; }};

/* ========== –°–û–°–¢–û–Ø–ù–ò–ï ========== */
let state = load('tg_state',{
  user:{id:1907547038,first_name:'–ò–≥—Ä–æ–∫'},
  stats:{happy:70,energy:70,clean:70},
  level:1, xp:0,
  coins:50,
  inventory:{apple:3,goldenApple:0,accessories:{bow:false,shades:false,crown:false}},
  shop:{interior:'default'},
  evol:1,
  quests:{items:[],resetAt:0,progress:{}},
  ach:{}, // id:true
  chestAt:0,
  weekly:{weekKey:'', daysHappy:0, rewarded:false},
  leaderboardLocal:[],
});
const ROOMS={
  default:{name:'–û–±—ã—á–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',price:0, bg:'linear-gradient(180deg,#101826,#0b1320)'},
  wood:{name:'–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è',price:120,bg:'url(https://images.unsplash.com/photo-1501045661006-fcebe0257c3f?auto=format&fit=crop&w=900&q=60)'},
  night:{name:'–ù–æ—á–Ω–∞—è',price:150,bg:'url(https://images.unsplash.com/photo-1542654071-08c7162cfb19?auto=format&fit=crop&w=900&q=60)'},
  neon:{name:'–ù–µ–æ–Ω',price:220,bg:'url(https://images.unsplash.com/photo-1517816743773-6e0fd518b4a6?auto=format&fit=crop&w=900&q=60)'}
};
const ITEMS=[
  {id:'apple',name:'–Ø–±–ª–æ–∫–æ',desc:'+15 –ï–¥–∞/–≠–Ω–µ—Ä–≥–∏—è/–ß–∏—Å—Ç–æ—Ç–∞ –ø–æ —á—É—Ç—å-—á—É—Ç—å',price:10},
  {id:'cleaner',name:'–ú—ã–ª–æ',desc:'–ß–∏—Å—Ç–æ—Ç–∞ +30',price:24},
  {id:'toy',name:'–ò–≥—Ä—É—à–∫–∞',desc:'–°—á–∞—Å—Ç—å–µ +25',price:35},
  {id:'gold',name:'–ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ',desc:'–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',craft:true}
];
const PREMIUM=[
  {id:'bow',name:'–ë–∞–Ω—Ç–∏–∫',price:0, premium:true},
  {id:'shades',name:'–û—á–∫–∏',price:0, premium:true},
  {id:'crown',name:'–ö–æ—Ä–æ–Ω–∞',price:0, premium:true},
];
const ACHS=[
  {id:'feed10',name:'–ú–æ–ª–æ–¥–µ—Ü-–∫–æ—Ä–º–∏–ª–µ—Ü',cond:s=>s._feed>=10, reward:20},
  {id:'first100',name:'–°–æ—Ç–æ—á–∫–∞ —Å—á–∞—Å—Ç—å—è',cond:s=>s.stats.happy>=100, reward:10},
  {id:'rich',name:'–ö–æ–ø–∏–ª–∫–∞',cond:s=>s.coins>=500, reward:50},
  {id:'runner',name:'–ë—ã—Å—Ç—Ä—ã–µ –ª–∞–ø–∫–∏',cond:s=>s._runScore>=150, reward:25},
];
const DAILY_POOL=[
  {id:'q_feed3', text:'–ü–æ–∫–æ—Ä–º–∏ –ø–∏—Ç–æ–º—Ü–∞ 3 —Ä–∞–∑–∞', type:'feed',need:3, reward:20},
  {id:'q_game1', text:'–°—ã–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—É 1 —Ä–∞–∑', type:'run',need:1, reward:15},
  {id:'q_clean1',text:'–ü–æ–≤—ã—à–∞–π —á–∏—Å—Ç–æ—Ç—É 1 —Ä–∞–∑', type:'clean',need:1, reward:10},
  {id:'q_sleep1',text:'–£–ª–æ–∂–∏ —Å–ø–∞—Ç—å 1 —Ä–∞–∑', type:'sleep',need:1, reward:10},
  {id:'q_emo5', text:'–û—Ç–ø—Ä–∞–≤—å 5 —ç–º–æ—Ü–∏–π', type:'emo',need:5, reward:10},
];

let session = {_feed:0,_runScore:0, _emo:0};

/* ========== –ò–ù–ò–¢ ========== */
function init(){
  // avatar/hello
  $('#hello').textContent = `–ü—Ä–∏–≤–µ—Ç, ${state.user.first_name || '–¥—Ä—É–≥'}!`;
  if(state.user.id===OWNER_ID) $('#isAdmin').classList.remove('hidden');
  // room bg
  applyInterior();
  // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  render();
  // –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã
  bootstrapDaily();
  // –Ω–µ–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
  updateWeeklyNote();
}
document.addEventListener('DOMContentLoaded',init);

/* ========== –†–ï–ù–î–ï–† ========= */
function render(){
  // –ø–æ–ª–æ—Å–∫–∏
  $('#bH').style.width = clamp(state.stats.happy,0,100)+'%';
  $('#bE').style.width = clamp(state.stats.energy,0,100)+'%';
  $('#bC').style.width = clamp(state.stats.clean,0,100)+'%';
  $('#statsText').textContent = `üòä ${state.stats.happy} ‚Ä¢ ‚ö° ${state.stats.energy} ‚Ä¢ üßº ${state.stats.clean}`;
  $('#coins').textContent = fmt(state.coins);
  $('#level').textContent = state.level;

  // —ç–≤–æ–ª—é—Ü–∏—è
  const stage = calcEvolution();
  const pet = $('#pet');
  pet.classList.remove('pet-stage-1','pet-stage-2','pet-stage-3');
  pet.classList.add(`pet-stage-${stage}`);
}

/* ========== –≠–í–û–õ–Æ–¶–ò–Ø ========= */
function calcEvolution(){
  const score = state.level*50 + (state.stats.happy+state.stats.energy+state.stats.clean);
  let ev = 1;
  if(score>=260) ev=3;
  else if(score>=200) ev=2;
  state.evol = ev;
  return ev;
}

/* ========== –ò–ù–¢–ï–†–¨–ï–† ========= */
function applyInterior(){
  const key = state.shop.interior || 'default';
  const room = ROOMS[key] || ROOMS.default;
  $('#room').style.background = room.bg;
}

/* ========== –°–û–•–†/–ó–ê–ì–† ========= */
function persist(){ save('tg_state',state); }
$('#btnSave').onclick=persist;
$('#btnReset').onclick=()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){ localStorage.removeItem('tg_state'); location.reload(); }};

/* ========== –î–ï–ô–°–¢–í–ò–Ø ========= */
$('#btnFeed').onclick=()=>{
  if(state.inventory.apple<=0 && state.inventory.goldenApple<=0){ toast('–ù—É–∂–Ω–æ —è–±–ª–æ–∫–æ! –ö—É–ø–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ'); return;}
  if(state.inventory.goldenApple>0){
    state.inventory.goldenApple--; state.stats.happy=state.stats.energy=state.stats.clean=100;
    toast('–ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ! –í—Å–µ —Å—Ç–∞—Ç—ã –ø–æ–ª–Ω—ã–µ ‚ú®'); grantAch('first100');
  } else {
    state.inventory.apple--; state.stats.happy=clamp(state.stats.happy+8,0,100);
    state.stats.energy=clamp(state.stats.energy+8,0,100);
    state.stats.clean =clamp(state.stats.clean +5,0,100);
  }
  session._feed++; bumpQuest('feed',1); grantAchMaybe();
  fxEmoji('üçé'); render(); persist();
};
$('#btnSleep').onclick=()=>{
  state.stats.energy=clamp(state.stats.energy+28,0,100);
  state.stats.clean =clamp(state.stats.clean -6 ,0,100);
  bumpQuest('sleep',1); fxEmoji('üò¥'); render(); persist();
};
$('#btnPlay').onclick=()=>openModal('#modalRun');
$('#btnQuest').onclick=()=>openModal('#modalQuests');
$('#btnAch').onclick =()=>openModal('#modalAch');
$('#btnShop').onclick =()=>{ buildShop(); openModal('#modalShop'); };
$('#btnSettings').onclick =()=>toast('–û—Ç–∫—Ä—ã—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∂–µ ‚§µÔ∏è');

/* –≠–º–æ—Ü–∏–∏ */
$('#reactionBar').addEventListener('click',(e)=>{
  const emo = e.target.dataset.emo; if(!emo) return;
  fxEmoji(emo); session._emo++; bumpQuest('emo',1);
});

/* –°—É–Ω–¥—É–∫ */
$('#btnChest').onclick=()=>{
  const nowTs = now();
  if(state.chestAt && nowTs < state.chestAt){ const left = Math.ceil((state.chestAt-nowTs)/60000); toast(`–°—É–Ω–¥—É–∫ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ ~${left} –º–∏–Ω`); return; }
  // –Ω–∞–≥—Ä–∞–¥–∞
  const roll = Math.random();
  if(roll<.5){ const c= 15+Math.floor(Math.random()*21); state.coins+=c; toast(`+${c} Seeds –∏–∑ —Å—É–Ω–¥—É–∫–∞ üí∞`); }
  else if(roll<.8){ state.inventory.apple+=1; toast(`+1 —è–±–ª–æ–∫–æ üçé`); }
  else { state.inventory.goldenApple+=1; toast(`–ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ ‚ú®`); }
  state.chestAt = now()+CHEST_COOLDOWN_MS; grantAchMaybe(); persist(); render();
};

/* ========== –ú–ê–ì–ê–ó–ò–ù ========= */
function buildShop(){
  const tab = $('#shopTabs .chip.active')?.dataset.tab || 'items';
  const box = $('#mShop'); box.innerHTML='';
  const addItem=(title,desc,price,action,disabled=false,tag='')=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div><div>
        <div><b>${title}</b> ${tag?`<span class="tag">${tag}</span>`:''}</div>
        <div class="small">${desc}</div>
      </div></div>
      <div>
        <span class="price">üí∞ ${price}</span>
        <button class="btn ${disabled?'hidden':''}">–ö—É–ø–∏—Ç—å</button>
      </div>`;
    el.querySelector('button')?.addEventListener('click',action);
    box.appendChild(el);
  };

  if(tab==='items'){
    ITEMS.forEach(it=>{
      if(it.craft){ // –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ñ—Ç
        const can = state.inventory.apple>=3;
        addItem('–ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ (–∫—Ä–∞—Ñ—Ç)','3 —è–±–ª–æ–∫–∞ ‚Üí 1 –∑–æ–ª–æ—Ç–æ–µ', '‚Äî', ()=>{
          if(state.inventory.apple<3) return toast('–ù—É–∂–Ω–æ 3 —è–±–ª–æ–∫–∞');
          state.inventory.apple-=3; state.inventory.goldenApple+=1; toast('–°–∫—Ä–∞—Ñ—Ç–∏–ª ‚ú® –ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ');
          persist(); render();
        }, !can, 'CRAFT');
      } else {
        addItem(it.name,it.desc,it.price,()=>{
          if(state.coins<it.price) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
          state.coins-=it.price; state.inventory[it.id]=(state.inventory[it.id]||0)+1;
          toast(`–ö—É–ø–ª–µ–Ω–æ: ${it.name}`); persist(); render();
        });
      }
    });
  }
  if(tab==='interiors'){
    Object.entries(ROOMS).forEach(([id,room])=>{
      const owned = (id==='default') || state.shop[id];
      addItem(room.name, owned?'–ö—É–ø–ª–µ–Ω–æ':'–§–æ–Ω –∫–æ–º–Ω–∞—Ç—ã', room.price || 0, ()=>{
        if(!owned){
          if(state.coins<room.price) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
          state.coins-=room.price; state.shop[id]=true;
        }
        state.shop.interior=id; applyInterior(); persist(); render();
      }, (id==='default' && state.shop.interior==='default'), owned?'OWNED':'');
    });
  }
  if(tab==='premium'){
    PREMIUM.forEach(p=>{
      const has = !!state.inventory.accessories[p.id];
      addItem(p.name,'–ê–∫—Å–µ—Å—Å—É–∞—Ä (–∫–æ—Å–º–µ—Ç–∏–∫–∞, –±–µ–∑ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤)','‚Äî',()=>{
        state.inventory.accessories[p.id]=true;
        toast('–ê–∫—Å–µ—Å—Å—É–∞—Ä –≤—ã–¥–∞–Ω'); persist();
      }, has,'FREE');
    });
  }
}
$('#shopTabs').addEventListener('click',(e)=>{
  const t=e.target.closest('.chip'); if(!t) return;
  $('#shopTabs .chip.active')?.classList.remove('active'); t.classList.add('active');
  buildShop();
});

/* ========== –ï–ñ–ï–î–ù–ï–í–ù–´–ï –ö–í–ï–°–¢–´ ========== */
function bootstrapDaily(){
  if(!state.quests.resetAt || now()>state.quests.resetAt){
    const items = pickRandom(DAILY_POOL,3);
    state.quests.items = items;
    state.quests.progress = Object.fromEntries(items.map(q=>[q.id,0]));
    state.quests.resetAt = todayUTC()+24*60*60*1000; // –∑–∞–≤—Ç—Ä–∞ 00:00 UTC
    persist();
  }
  renderQuests();
  tickQuestTimer();
}
function renderQuests(){
  const box = $('#questList'); box.innerHTML='';
  state.quests.items.forEach(q=>{
    const cur = state.quests.progress[q.id]||0;
    const done = cur>=q.need;
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><div><b>${q.text}</b></div><div class="small">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${cur}/${q.need}</div></div>
      <div>${done?`<span class="badge">–ù–∞–≥—Ä–∞–¥–∞: ${q.reward}</span>`:`<button class="btn ok">–ó–∞–±—Ä–∞—Ç—å (${q.reward})</button>`}</div>`;
    if(!done) el.querySelector('button')?.addEventListener('click',()=>{
      if(state.quests.progress[q.id]<q.need) return toast('–ó–∞–¥–∞–Ω–∏–µ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
    });
    if(done) el.querySelector('button')?.remove();
    if(done && !el.querySelector('.badge')){/*noop*/}
    if(done){ // –≤—ã–¥–∞—á–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å
      el.querySelector('div:last-child').addEventListener('click',()=>{
        if(state.quests.progress[q.id]===Infinity) return; // —É–∂–µ –∑–∞–±—Ä–∞–Ω–æ
        state.coins+=q.reward; state.quests.progress[q.id]=Infinity; toast(`+${q.reward} Seeds`);
        render(); renderQuests(); persist();
      });
    }
    box.appendChild(el);
  });
}
function bumpQuest(type,delta){
  state.quests.items.forEach(q=>{
    if(q.type===type && state.quests.progress[q.id]!==Infinity){
      state.quests.progress[q.id] = clamp((state.quests.progress[q.id]||0)+delta,0,q.need);
    }
  });
  renderQuests(); persist();
}
function tickQuestTimer(){
  const left = Math.max(0, state.quests.resetAt-now());
  $('#questLeft').textContent = fmtTime(left);
  if(left<=0) bootstrapDaily();
  setTimeout(tickQuestTimer,1000);
}
function todayUTC(){
  const d=new Date(); return Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate());
}
function fmtTime(ms){
  const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function pickRandom(arr,n){
  const a=[...arr]; const out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); }
  return out;
}

/* ========== –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ========== */
function grantAch(id){ state.ach[id]=true; persist(); renderAch(); }
function grantAchMaybe(){
  ACHS.forEach(a=>{ try{ if(!state.ach[a.id] && a.cond({...state,...session})) { state.ach[a.id]=true; state.coins+=a.reward; toast(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name} (+${a.reward})`); } }catch{} });
  persist(); render(); renderAch();
}
$('#btnAch').onclick=()=>{ renderAch(); openModal('#modalAch'); };
function renderAch(){
  const box=$('#achList'); box.innerHTML='';
  ACHS.forEach(a=>{
    const done=!!state.ach[a.id];
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><b>${a.name}</b><div class="small">–ù–∞–≥—Ä–∞–¥–∞: ${a.reward}</div></div>
      <div>${done?'<span class="badge">–ü–æ–ª—É—á–µ–Ω–æ</span>':'<span class="tag">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>'}</div>`;
    box.appendChild(el);
  });
}

/* ========== –ú–ò–ù–ò-–ò–ì–†–ê ========= */
let runTimer=null, runLeft=10.0, runScore=0;
$('#runStart').onclick=()=>{
  if(runTimer){ return; }
  runLeft=10.0; runScore=0; $('#runBar').style.width='0%'; $('#runScore').textContent=runScore; $('#runTime').textContent=runLeft.toFixed(1);
  const tap=()=>{ if(!runTimer) return; runScore++; $('#runScore').textContent=runScore; $('#runBar').style.width=Math.min(100,runScore)+'%'; };
  $('#gameRun').onclick=tap;
  runTimer=setInterval(()=>{
    runLeft=Math.max(0,runLeft-0.1); $('#runTime').textContent=runLeft.toFixed(1);
    if(runLeft<=0){ clearInterval(runTimer); runTimer=null; $('#gameRun').onclick=null;
      const reward = Math.min(60, 10+Math.floor(runScore/3));
      state.coins+=reward; session._runScore=runScore; grantAchMaybe();
      toast(`–§–∏–Ω–∏—à! +${reward} Seeds`);
      bumpQuest('run',1); render(); persist();
    }
  },100);
};

/* ========== –õ–ò–î–ï–†–ë–û–†–î–´ ========== */
$('#btnLB').onclick=()=>{ renderLB(); openModal('#modalLB'); };
$('#syncLocal').onclick=()=>{ pushLocalScore(); renderLB(); };
$('#pushGlobal').onclick=()=>{ if(!BACKEND_URL){ toast('–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'); return; } pushGlobal(); };
$('#pullGlobal').onclick=()=>{ if(!BACKEND_URL){ toast('–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'); return; } getGlobal(); };

function pushLocalScore(){
  const score = Math.round(state.stats.happy*2 + state.coins*0.2 + state.level*5);
  const item ={name:state.user.first_name||'–ò–≥—Ä–æ–∫', score, time:new Date().toISOString()};
  state.leaderboardLocal.unshift(item); state.leaderboardLocal=state.leaderboardLocal.slice(0,20); persist();
}
function renderLB(){
  $('#lbInfo').textContent = BACKEND_URL? '–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø–µ–Ω':'–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª—é—á—ë–Ω (–æ–∂–∏–¥–∞–µ—Ç BACKEND_URL)';
  const loc = $('#lbLocal'); loc.innerHTML='';
  (state.leaderboardLocal||[]).forEach((r,i)=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><b>${i+1}. ${r.name}</b><div class="small">${new Date(r.time).toLocaleString()}</div></div><div><b>${r.score}</b></div>`;
    loc.appendChild(el);
  });
}
async function pushGlobal(){
  try{
    const score = Math.round(state.stats.happy*2 + state.coins*0.2 + state.level*5);
    await fetch(BACKEND_URL+'/api/leaderboard/push',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:state.user.first_name, score})});
    toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø');
  }catch{ toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}
async function getGlobal(){
  try{
    const data = await fetch(BACKEND_URL+'/api/leaderboard/top').then(r=>r.json());
    const box=$('#lbGlobal'); box.innerHTML='';
    data.forEach((r,i)=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`<div><b>${i+1}. ${r.name}</b></div><div><b>${r.score}</b></div>`;
      box.appendChild(el);
    });
  }catch{ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ø'); }
}

/* ========== –ù–ï–î–ï–õ–¨–ù–û–ï –°–û–ë–´–¢–ò–ï ========= */
function weekKey(){
  const d=new Date(); const y=d.getUTCFullYear(); const w=Math.floor((Date.UTC(y,d.getUTCMonth(),d.getUTCDate())-Date.UTC(y,0,1))/(7*24*3600*1000));
  return `${y}-W${w}`;
}
function updateWeeklyNote(){
  const key=weekKey();
  if(state.weekly.weekKey!==key){ // –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è
    state.weekly={weekKey:key,daysHappy:0,rewarded:false};
  }
  const d=new Date(); const todayKey=d.toDateString();
  // –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–Ω—å –µ—Å–ª–∏ —Å—á–∞—Å—Ç—å–µ >=90 –∏ –µ—â—ë –Ω–µ —Å—á–∏—Ç–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è
  let mark=load('week_mark','');
  if(state.stats.happy>=90 && mark!==todayKey){
    state.weekly.daysHappy++; save('week_mark',todayKey); persist();
  }
  const leftDays = 7 - d.getUTCDay(); // –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞
  $('#weeklyNote').textContent = `–ù–µ–¥–µ–ª—è —Å—á–∞—Å—Ç—å—è: ${state.weekly.daysHappy}/7 ‚Ä¢ –æ—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π ~${leftDays}`;
  if(!state.weekly.rewarded && state.weekly.daysHappy>=WEEKLY_DAYS_GOAL){
    state.coins+=100; state.weekly.rewarded=true; toast('–ù–∞–≥—Ä–∞–¥–∞ –Ω–µ–¥–µ–ª–∏: +100 Seeds!'); persist(); render();
  }
}

/* ========== –í–ò–ó–ò–¢ –ö –î–†–£–ì–£ (—Å–Ω–∞–ø—à–æ—Ç) ========== */
$('#btnSnapshot').onclick=()=>{
  const data = {pet:state.stats, deco:state.shop, name:state.user.first_name, happy:state.stats.happy};
  const code = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  copy(code); toast('–°–Ω–∞–ø—à–æ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä. –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É!');
};
$('#btnVisit').onclick = ()=>openModal('#modalVisit');
$('#visitPreview').onclick=()=>{
  try{
    const code=$('#visitCode').value.trim(); if(!code) return;
    const data = JSON.parse(decodeURIComponent(escape(atob(code))));
    $('#visitState').textContent = `–ì–æ—Å—Ç—å: ${data.name || '–¥—Ä—É–≥'} ‚Ä¢ —Å—á–∞—Å—Ç—å–µ ${data.happy}`;
  }catch{ $('#visitState').textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'; }
};
$('#visitGiveHeart').onclick=()=>{
  const code=$('#visitCode').value.trim(); if(!code) return;
  try{
    const data=JSON.parse(decodeURIComponent(escape(atob(code))));
    data.happy = clamp((data.happy||0)+1,0,100);
    const newCode=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    $('#visitState').textContent = '–ü–æ–¥–∞—Ä–µ–Ω–æ ‚ù§Ô∏è. –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É –Ω–æ–≤—ã–π –∫–æ–¥: '+newCode.slice(0,24)+'...';
  }catch{ $('#visitState').textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'; }
};

/* ========== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ========== */
if(state.user.id===OWNER_ID) $('#devPanel').classList.remove('hidden');
$('#devCoins').onclick=()=>{ state.coins+=1000; render(); persist(); };
$('#devAcc').onclick =()=>{ state.inventory.accessories={bow:true,shades:true,crown:true}; persist(); toast('–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –≤—ã–¥–∞–Ω—ã'); };
$('#devMax').onclick  =()=>{ state.stats={happy:100,energy:100,clean:100}; render(); persist(); };

/* ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï ========= */
function fxEmoji(e){
  const box=$('#fx'); const el=document.createElement('div'); el.className='emoji'; el.textContent=e;
  const x= 80+Math.random()*100, y=120+Math.random()*40;
  el.style.left=x+'px'; el.style.top=y+'px'; box.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}
function openModal(sel){ const m=$(sel); m.classList.add('show'); m.addEventListener('click',ev=>{ if(ev.target===m || ev.target.dataset.close!==undefined) m.classList.remove('show'); },{once:true});}
function toast(t){ const el=document.createElement('div'); el.textContent=t; Object.assign(el.style,{position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',padding:'10px 14px',borderRadius:'12px',background:'#000c',border:'1px solid #fff2',color:'#fff',zIndex:40}); document.body.appendChild(el); setTimeout(()=>el.remove(),2000); }
function copy(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }

</script>
</body>
</html>
