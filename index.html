<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tamagocho</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1620; --card:#151e2f; --muted:#8bb2d0; --text:#e6eef8;
      --accent:#80d2ee; --ok:#34d399; --warn:#f59e0b; --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --brand:#87CEEB;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:480px;margin:0 auto;padding:18px 12px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .header{align-items:center;gap:12px;margin-bottom:12px}
    .avatar{width:72px;height:72px;border-radius:16px;object-fit:cover;border:2px solid var(--brand)}
    h1{font-size:18px;margin:0 0 2px}
    .muted{color:var(--muted);font-size:13px}

    .pet-box{display:flex;flex-direction:column;align-items:center;padding:10px 6px}
    .pet{position:relative;width:260px;height:260px;border-radius:18px;overflow:hidden;background:#2b3a4f;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
    .pet img.base{width:100%;height:100%;object-fit:cover}
    .pet .acc{position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:center;font-size:56px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
    .bars{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .bar{height:12px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#5eead4);width:50%}
    .bar .label{margin-top:4px;font-size:12px;color:var(--muted)}
    .stat-line{display:flex;align-items:center;gap:8px;justify-content:space-between}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .btn{border:none;border-radius:12px;padding:12px;font-weight:600;background:#1f2a44;color:#eaf6ff;box-shadow:var(--shadow)}
    .btn:active{opacity:.9;transform:translateY(1px)}
    .btn.ok{background:#1f4337}
    .btn.warn{background:#4a3514}
    .btn.accent{background:#17334a}
    .btn.brand{background:#10435c}

    .section{margin-top:14px}
    .pill{background:#12233a;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .sheet{background:var(--card);border-radius:16px;max-width:520px;width:100%;max-height:82vh;overflow:auto;box-shadow:var(--shadow);padding:14px}
    .sheet h2{margin:4px 0 8px;font-size:18px}
    .shop-list,.inv-list,.quest-list,.lb-list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#101b2e;border-radius:12px;padding:10px}
    .item .meta{display:flex;gap:10px;align-items:center}
    .price{font-weight:700;color:#ffe08a}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;background:#0e253c;color:#a9c6de}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0}

    .topbar{display:flex;align-items:center;justify-content:space-between}
    .coins{display:flex;align-items:center;gap:8px;font-weight:700}
    .coins i{font-style:normal;color:#ffe08a}
    .level{font-size:12px;color:#a3c7dc}

    .kbd{font-family:ui-monospace,monospace;background:#0f1d2f;border-radius:6px;padding:2px 6px;border:1px solid rgba(255,255,255,.06);font-size:12px}
    .hint{color:#9ec5dd;font-size:12px}
    .mini{font-size:12px;color:#9dbddb}

    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .danger{color:#ffb4b4}
    .success{color:#8ff1bd}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row header card">
      <div class="row" style="gap:12px">
        <img class="avatar" src="pet.webp" alt="pet"/>
        <div>
          <h1 id="greet">TAMAGOCHO</h1>
          <div class="level" id="levelText">LVL 1 ‚Ä¢ EXP 0/100</div>
          <div class="muted" id="username">–ü—Ä–∏–≤–µ—Ç!</div>
        </div>
      </div>
      <div class="coins"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18'><circle cx='9' cy='9' r='8' fill='%23ffd866'/><circle cx='7' cy='7' r='2.5' fill='%23ffb400'/></svg>"> <i id="coins">0</i></div>
    </div>

    <div class="card">
      <div class="pet-box">
        <div class="pet" id="petBox">
          <img class="base" id="petImg" src="pet.webp" alt="–ü–∏—Ç–æ–º–µ—Ü">
          <div class="acc" id="accLayer"></div>
        </div>
        <div class="bars" id="bars">
          <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div class="grid">
          <button class="btn ok" id="btnFeed">–ü–æ–∫–æ—Ä–º–∏—Ç—å</button>
          <button class="btn accent" id="btnPlay">–ü–æ–∏–≥—Ä–∞—Ç—å</button>
          <button class="btn brand" id="btnWash">–ü–æ–º—ã—Ç—å</button>
          <button class="btn warn" id="btnSleep">–°–ø–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="section row">
      <span class="pill">–ú–µ–Ω—é</span>
      <div class="right flex">
        <button class="btn" id="btnInventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        <button class="btn" id="btnShop">–ú–∞–≥–∞–∑–∏–Ω</button>
      </div>
    </div>

    <div class="grid">
      <button class="btn" id="btnQuests">–ö–≤–µ—Å—Ç—ã</button>
      <button class="btn" id="btnMini">–ú–∏–Ω–∏-–∏–≥—Ä–∞</button>
      <button class="btn" id="btnLeaderboard">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
      <button class="btn" id="btnSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="mini" style="margin-top:10px">üí° –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —Å–Ω–∏–∂–∞—é—Ç—Å—è. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏, –≤—ã–ø–æ–ª–Ω—è–π –∫–≤–µ—Å—Ç—ã, –∏–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—É –∏ –∫–æ–ø–∏ —Å–µ–º–µ—á–∫–∏!</div>
  </div>

  <!-- SHOP -->
  <div class="modal" id="modalShop">
    <div class="sheet">
      <div class="topbar">
        <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div class="coins"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='7' fill='%23ffd866'/></svg>"> <i id="coinsShop">0</i></div>
      </div>
      <div class="sep"></div>

      <div class="tag">–û–±—ã—á–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
      <div class="shop-list" id="shopRegular"></div>

      <div class="sep"></div>
      <div class="tag">–ü—Ä–µ–º–∏—É–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã (–∫–æ—Å–º–µ—Ç–∏–∫–∞)</div>
      <div class="shop-list" id="shopPremium"></div>

      <div class="sep"></div>
      <button class="btn right" id="closeShop">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- INVENTORY -->
  <div class="modal" id="modalInv">
    <div class="sheet">
      <div class="topbar">
        <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div class="hint">–¢–∞–ø –ø–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä—É ‚Äî –Ω–∞–¥–µ—Ç—å/—Å–Ω—è—Ç—å</div>
      </div>
      <div class="sep"></div>
      <div class="tag">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</div>
      <div class="inv-list" id="invConsumables"></div>
      <div class="sep"></div>
      <div class="tag">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
      <div class="inv-list" id="invAccessories"></div>
      <div class="sep"></div>
      <button class="btn right" id="closeInv">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- QUESTS -->
  <div class="modal" id="modalQuests">
    <div class="sheet">
      <div class="topbar">
        <h2>–ö–≤–µ—Å—Ç—ã –¥–Ω—è</h2>
        <span class="hint">–°–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ</span>
      </div>
      <div class="sep"></div>
      <div class="quest-list" id="questList"></div>
      <div class="sep"></div>
      <button class="btn right" id="closeQuests">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- MINI GAME -->
  <div class="modal" id="modalMini">
    <div class="sheet">
      <div class="topbar">
        <h2>–ú–∏–Ω–∏-–∏–≥—Ä–∞: Tap-Love</h2>
        <span class="hint">–ù–∞–∂–∏–º–∞–π –Ω–∞ –ø–∏—Ç–æ–º—Ü–∞ –∏ –Ω–∞–±–µ—Ä–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ ‚Äú—Å–µ—Ä–¥–µ—Ü‚Äù –∑–∞ 10 —Å–µ–∫—É–Ω–¥!</span>
      </div>
      <div class="sep"></div>
      <div class="pet" id="miniPet" style="width:220px;height:220px;margin:0 auto">
        <img class="base" src="pet.webp" alt="">
        <div class="acc" id="miniAcc"></div>
      </div>
      <div class="row" style="justify-content:center;margin:10px 0">
        <div class="pill">‚è± <span id="miniTime">10</span>s</div>
        <div class="pill">‚ù§Ô∏è <span id="miniScore">0</span></div>
      </div>
      <div class="sep"></div>
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="startMini">–°—Ç–∞—Ä—Ç</button>
        <button class="btn" id="closeMini">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="modal" id="modalLB">
    <div class="sheet">
      <div class="topbar">
        <h2>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>
        <span class="hint">–°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å –ø–æ —É—Ä–æ–≤–Ω—é –∏ –æ–±—â–µ–º—É –æ–ø—ã—Ç—É</span>
      </div>
      <div class="sep"></div>
      <div class="tag">–õ–æ–∫–∞–ª—å–Ω—ã–π (–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)</div>
      <div class="lb-list" id="lbLocal"></div>
      <div class="sep"></div>
      <div class="tag">–ì–ª–æ–±–∞–ª—å–Ω—ã–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
      <div class="lb-list" id="lbGlobal"></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn" id="syncLocal">–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π</button>
        <button class="btn" id="pushGlobal">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π</button>
        <button class="btn right" id="closeLB">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="mini">üõ∞ –ï—Å–ª–∏ –ø–æ–∑–∂–µ —É–∫–∞–∂–µ—à—å BACKEND_URL, –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="modal" id="modalSettings">
    <div class="sheet">
      <div class="topbar"><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
      <div class="sep"></div>
      <div class="item">
        <div class="meta">
          <div>
            <div class="muted">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="mini">–£–¥–∞–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
          </div>
        </div>
        <button class="btn danger" id="wipeSave">–°–±—Ä–æ—Å</button>
      </div>

      <div id="devPanel" class="hidden">
        <div class="sep"></div>
        <div class="tag">–ü–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è</div>
        <div class="item">
          <div class="meta"><b>+1000 Seeds</b></div>
          <button class="btn ok" id="devCoins">–í—ã–¥–∞—Ç—å</button>
        </div>
        <div class="item">
          <div class="meta"><b>–í—ã–¥–∞—Ç—å –≤—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</b></div>
          <button class="btn ok" id="devAcc">–í—ã–¥–∞—Ç—å</button>
        </div>
      </div>

      <div class="sep"></div>
      <button class="btn right" id="closeSettings">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const OWNER_ID = 1907547038; // —Ç–≤–æ–π Telegram user id (–∏–∑ RawDataBot)
    const BACKEND_URL = ""; // –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—à—å –±—ç–∫–µ–Ω–¥ (Render) ‚Äî —Å—é–¥–∞ –µ–≥–æ –±–∞–∑–æ–≤—ã–π URL, –∏–Ω–∞—á–µ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º

    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.setHeaderColor("#101820");
      tg.setBackgroundColor("#0f1620");
    }

    // ========= STATE =========
    const now = () => Date.now();
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    const defaultState = (uid, name) => ({
      user:{ id: uid, name: name || "–ì–æ—Å—Ç—å" },
      coins: 120,
      lvl: 1,
      exp: 0,
      expNext: 100,
      stats: {
        health: 85, hunger: 70, mood: 70, hygiene: 70, energy: 80
      },
      lastTick: now(),
      inventory:{
        consumables:{
          food: 2, soap: 1, toy: 0, pillow: 1
        },
        accessories:{ bow:false, shades:false, crown:false },
        equipped:{ bow:false, shades:false, crown:false }
      },
      quests: genDailyQuests(),
      bestMini: 0,
      leaderboardLocal: [], // [{name, lvl, exp, date}]
    });

    function genDailyQuests(){
      return [
        { id:"feed3", title:"–ü–æ–∫–æ—Ä–º–∏—Ç—å —Ö–æ–º—è–∫–∞ 3 —Ä–∞–∑–∞", progress:0, goal:3, reward:40, exp:20, done:false },
        { id:"play2", title:"–ü–æ–∏–≥—Ä–∞—Ç—å 2 —Ä–∞–∑–∞", progress:0, goal:2, reward:30, exp:15, done:false },
        { id:"mini1", title:"–°—ã–≥—Ä–∞—Ç—å –≤ –º–∏–Ω–∏-–∏–≥—Ä—É 1 —Ä–∞–∑", progress:0, goal:1, reward:35, exp:20, done:false },
        { id:"clean1", title:"–ü–æ–º—ã—Ç—å 1 —Ä–∞–∑", progress:0, goal:1, reward:25, exp:10, done:false },
      ];
    }

    // ========= LOAD/SAVE =========
    function storageKey(uid){ return `tamagocho:${uid||"guest"}`; }

    function loadState(){
      const unsafe = tg?.initDataUnsafe;
      const uid = unsafe?.user?.id || "guest";
      const name = unsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
      const key = storageKey(uid);
      const raw = localStorage.getItem(key);
      let s = raw ? JSON.parse(raw) : defaultState(uid, name);
      // –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±—Ä–æ—Å –∫–≤–µ—Å—Ç–æ–≤
      const last = localStorage.getItem(key+":qday");
      const today = new Date().toDateString();
      if (last !== today){
        s.quests = genDailyQuests();
        localStorage.setItem(key+":qday", today);
      }
      return s;
    }

    function saveState(){
      localStorage.setItem(storageKey(state.user.id), JSON.stringify(state));
      renderAll();
    }

    // ========= GAME TICK =========
    function tick(){
      const dt = (now() - state.lastTick)/1000; // sec
      if (dt > 2){ // –≤–Ω–µ —Ñ–æ–∫—É—Å–∞/–≤–æ–∑–≤—Ä–∞—Ç ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
        const decay = Math.min(dt/60, 20); // –Ω–µ –æ–±–Ω—É–ª—è—Ç—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
        // –±–∞–∑–æ–≤—ã–π —Å–ø–∞–¥
        state.stats.hunger = clamp(state.stats.hunger - 0.05*decay, 0, 100);
        state.stats.mood   = clamp(state.stats.mood   - 0.04*decay, 0, 100);
        state.stats.hygiene= clamp(state.stats.hygiene- 0.03*decay, 0, 100);
        state.stats.energy = clamp(state.stats.energy - 0.03*decay, 0, 100);
        // –∑–¥–æ—Ä–æ–≤—å–µ –ø–∞–¥–∞–µ—Ç –µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Å–µ–ª–∏
        const avg = (state.stats.hunger+state.stats.mood+state.stats.hygiene+state.stats.energy)/4;
        if (avg < 40) state.stats.health = clamp(state.stats.health - 0.08*decay, 0, 100);
        else state.stats.health = clamp(state.stats.health + 0.02*decay, 0, 100);
      }
      state.lastTick = now();
      saveState();
    }
    setInterval(tick, 6000);

    // ========= ACTIONS =========
    function addExp(v){
      state.exp += v;
      while (state.exp >= state.expNext){
        state.exp -= state.expNext;
        state.lvl++;
        state.expNext = Math.round(state.expNext*1.25);
        toast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${state.lvl}!`);
      }
    }

    function spendCoins(n){ if (state.coins>=n){ state.coins-=n; return true } return false; }
    function giveCoins(n){ state.coins += n; }

    function useConsumable(key){
      const have = state.inventory.consumables[key]||0;
      if (!have) return toast("–ù–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ");
      state.inventory.consumables[key]--;
      if (key==="food")     { state.stats.hunger = 100; addExp(5); }
      if (key==="soap")     { state.stats.hygiene= 100; addExp(5); }
      if (key==="toy")      { state.stats.mood   = clamp(state.stats.mood+50,0,100); addExp(6);}
      if (key==="pillow")   { state.stats.energy = 100; addExp(6); }
      saveState();
    }

    function toggleAccessory(key){
      const have = !!state.inventory.accessories[key];
      if (!have) return toast("–°–Ω–∞—á–∞–ª–∞ –∫—É–ø–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä –≤ –º–∞–≥–∞–∑–∏–Ω–µ");
      const cur = !!state.inventory.equipped[key];
      state.inventory.equipped[key] = !cur;
      saveState();
    }

    // –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–±–µ–∑ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤)
    document.addEventListener("click", (e)=>{
      if (e.target.id==="btnFeed"){
        state.stats.hunger = clamp(state.stats.hunger+25,0,100);
        incQuest("feed3",1);
        addExp(3);
        toast("üçΩ –ü–∏—Ç–æ–º–µ—Ü –¥–æ–≤–æ–ª–µ–Ω!");
        saveState();
      }
      if (e.target.id==="btnPlay"){
        state.stats.mood = clamp(state.stats.mood+18,0,100);
        incQuest("play2",1);
        addExp(3);
        saveState();
      }
      if (e.target.id==="btnWash"){
        state.stats.hygiene = clamp(state.stats.hygiene+18,0,100);
        incQuest("clean1",1);
        addExp(3);
        saveState();
      }
      if (e.target.id==="btnSleep"){
        state.stats.energy = clamp(state.stats.energy+25,0,100);
        addExp(3);
        saveState();
      }
    });

    // ========= QUESTS =========
    function incQuest(id, v){
      const q = state.quests.find(x=>x.id===id);
      if (!q || q.done) return;
      q.progress = clamp(q.progress + (v||1), 0, q.goal);
      if (q.progress >= q.goal){
        q.done = true;
        giveCoins(q.reward);
        addExp(q.exp);
        toast(`‚úÖ –ö–≤–µ—Å—Ç ‚Äú${q.title}‚Äù –≤—ã–ø–æ–ª–Ω–µ–Ω! +${q.reward} Seeds, +${q.exp} EXP`);
      }
      saveState();
    }

    // ========= MINI GAME =========
    let miniTimer=null, miniLeft=10, miniScore=0;
    function startMini(){
      miniLeft = 10; miniScore = 0;
      $("#miniTime").textContent = miniLeft;
      $("#miniScore").textContent = miniScore;
      clearInterval(miniTimer);
      miniTimer = setInterval(()=>{
        miniLeft--; $("#miniTime").textContent = miniLeft;
        if (miniLeft<=0){
          clearInterval(miniTimer);
          const prize = 10 + Math.floor(miniScore/3);
          giveCoins(prize);
          addExp(10);
          incQuest("mini1",1);
          if (miniScore>state.bestMini) state.bestMini = miniScore;
          saveState();
          toast(`üèÅ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${miniScore}. –ù–∞–≥—Ä–∞–¥–∞ +${prize} Seeds`);
        }
      }, 1000);
    }

    // ========= LEADERBOARD =========
    async function refreshLocalLB(){
      // —Ö—Ä–∞–Ω–∏–º —Ç–æ–ø-10 –ª–æ–∫–∞–ª—å–Ω–æ
      const entry = { name: state.user.name, lvl: state.lvl, exp: state.exp, date: new Date().toISOString() };
      let arr = state.leaderboardLocal||[];
      arr.unshift(entry);
      arr = arr.slice(0,10);
      state.leaderboardLocal = arr;
      saveState();
    }

    async function pushGlobal(){
      if (!BACKEND_URL){ toast("–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω"); return; }
      try{
        await fetch(`${BACKEND_URL}/api/leaderboard/push`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id: state.user.id, name: state.user.name, lvl: state.lvl, exp: state.exp })
        });
        toast("üåç –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥");
      }catch(e){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥"); }
    }
    async function getGlobal(){
      $("#lbGlobal").innerHTML = `<div class="mini">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
      if (!BACKEND_URL){ $("#lbGlobal").innerHTML = `<div class="mini">–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>`; return; }
      try{
        const r = await fetch(`${BACKEND_URL}/api/leaderboard/top`);
        const data = await r.json();
        $("#lbGlobal").innerHTML = data.map((x,i)=>lbRow(i+1, x.name, x.lvl, x.exp)).join("");
      }catch(e){
        $("#lbGlobal").innerHTML = `<div class="mini">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
      }
    }

    // ========= SHOP =========
    const REGULAR = [
      {key:"food",  title:"–ö–æ—Ä–º",    price:25,  desc:"–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—ã—Ç–æ—Å—Ç—å", onUse:()=>useConsumable("food")},
      {key:"soap",  title:"–ú—ã–ª–æ",    price:25,  desc:"–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–∏–≥–∏–µ–Ω—É", onUse:()=>useConsumable("soap")},
      {key:"toy",   title:"–ò–≥—Ä—É—à–∫–∞", price:35,  desc:"–°–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",        onUse:()=>useConsumable("toy")},
      {key:"pillow",title:"–ü–æ–¥—É—à–∫–∞", price:30,  desc:"–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é", onUse:()=>useConsumable("pillow")},
    ];
    const PREMIUM = [
      {key:"bow",    title:"–ë–∞–Ω—Ç–∏–∫ üéÄ",      price:120, premium:true},
      {key:"shades", title:"–û—á–∫–∏ üòé",        price:150, premium:true},
      {key:"crown",  title:"–ö–æ—Ä–æ–Ω–∞ üëë",      price:220, premium:true},
    ];

    function buyItem(item){
      if (!spendCoins(item.price)) return toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Seeds");
      if (item.premium){
        state.inventory.accessories[item.key] = true;
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.title}`);
      }else{
        state.inventory.consumables[item.key] = (state.inventory.consumables[item.key]||0)+1;
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.title}`);
      }
      addExp(4);
      saveState();
    }

    // ========= RENDER =========
    function $(sel){ return document.querySelector(sel); }
    function bar(name,val,color){
      return `
        <div>
          <div class="stat-line"><span class="muted">${name}</span><span>${Math.round(val)}%</span></div>
          <div class="bar"><i style="width:${val}%;background:${color}"></i></div>
        </div>`;
    }
    function renderBars(){
      const s = state.stats;
      $("#bars").innerHTML = 
        bar("–ó–¥–æ—Ä–æ–≤—å–µ", s.health, "linear-gradient(90deg,#34d399,#22c55e)")+
        bar("–°—ã—Ç–æ—Å—Ç—å",  s.hunger, "linear-gradient(90deg,#f59e0b,#fde047)")+
        bar("–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", s.mood, "linear-gradient(90deg,#60a5fa,#22d3ee)")+
        bar("–ì–∏–≥–∏–µ–Ω–∞", s.hygiene, "linear-gradient(90deg,#a78bfa,#8b5cf6)")+
        bar("–≠–Ω–µ—Ä–≥–∏—è", s.energy, "linear-gradient(90deg,#fb7185,#fda4af)");
    }
    function renderHeader(){
      $("#coins").textContent = state.coins;
      $("#coinsShop").textContent = state.coins;
      $("#levelText").textContent = `LVL ${state.lvl} ‚Ä¢ EXP ${state.exp}/${state.expNext}`;
      const uname = state.user.name || "–ò–≥—Ä–æ–∫";
      $("#username").textContent = `–ü—Ä–∏–≤–µ—Ç, ${uname}!`;
      $("#greet").textContent = "TAMAGOCHO";
      // –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã
      const wear = [];
      if (state.inventory.equipped.bow) wear.push("üéÄ");
      if (state.inventory.equipped.shades) wear.push("üï∂Ô∏è");
      if (state.inventory.equipped.crown) wear.push("üëë");
      $("#accLayer").textContent = wear.join(" ");
      $("#miniAcc").textContent = wear.join(" ");
      if (state.user.id==OWNER_ID) $("#devPanel").classList.remove("hidden");
    }
    function renderShop(){
      $("#shopRegular").innerHTML = REGULAR.map(it=>`
        <div class="item">
          <div class="meta">
            <div>
              <b>${it.title}</b>
              <div class="mini">${it.desc||""}</div>
            </div>
          </div>
          <div class="flex">
            <div class="price">üí∞ ${it.price}</div>
            <button class="btn ok" data-buy="${it.key}">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      `).join("");
      $("#shopPremium").innerHTML = PREMIUM.map(it=>`
        <div class="item">
          <div class="meta">
            <div><b>${it.title}</b><div class="mini">–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–∫—Å–µ—Å—Å—É–∞—Ä</div></div>
          </div>
          <div class="flex">
            <div class="price">üíé ${it.price}</div>
            <button class="btn ok" data-buy="${it.key}" data-premium="1">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      `).join("");
    }
    function renderInventory(){
      const c = state.inventory.consumables;
      $("#invConsumables").innerHTML = REGULAR.map(it=>{
        const n = c[it.key]||0;
        return `
          <div class="item">
            <div class="meta"><b>${it.title}</b><span class="tag">x${n}</span></div>
            <button class="btn" data-use="${it.key}" ${n? "":"disabled"}>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
          </div>`;
      }).join("");
      const a = state.inventory.accessories, e = state.inventory.equipped;
      $("#invAccessories").innerHTML = PREMIUM.map(it=>{
        const have = !!a[it.key];
        const on = !!e[it.key];
        return `
          <div class="item">
            <div class="meta"><b>${it.title}</b> ${have? (on? '<span class="tag">–Ω–∞–¥–µ—Ç–æ</span>':'<span class="tag">–µ—Å—Ç—å</span>'):'<span class="tag">–Ω–µ—Ç</span>'}</div>
            <button class="btn" data-toggle="${it.key}" ${have? "":"disabled"}>${on?"–°–Ω—è—Ç—å":"–ù–∞–¥–µ—Ç—å"}</button>
          </div>`;
      }).join("");
    }
    function renderQuests(){
      $("#questList").innerHTML = state.quests.map(q=>{
        const pct = Math.floor(100*q.progress/q.goal);
        return `
          <div class="item">
            <div class="meta" style="flex:1">
              <div>
                <b>${q.title}</b>
                <div class="mini">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${q.progress}/${q.goal} ‚Ä¢ –ù–∞–≥—Ä–∞–¥–∞: +${q.reward} Seeds, +${q.exp} EXP</div>
                <div class="bar"><i style="width:${pct}%;background:linear-gradient(90deg,#60a5fa,#22d3ee)"></i></div>
              </div>
            </div>
            <div>${q.done?'<span class="success">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>':'<span class="hint">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>'}</div>
          </div>`;
      }).join("");
    }
    function lbRow(pos,name,lvl,exp){
      return `<div class="item"><div class="meta"><b>#${pos}</b> <span>${name}</span></div><div class="mini">LVL ${lvl} ‚Ä¢ EXP ${exp}</div></div>`;
    }
    function renderLB(){
      const arr = state.leaderboardLocal||[];
      $("#lbLocal").innerHTML = arr.map((x,i)=>lbRow(i+1,x.name,x.lvl,x.exp)).join("") || `<div class="mini">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚Äú–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π‚Äù.</div>`;
    }
    function renderAll(){ renderHeader(); renderBars(); }

    // ========= EVENTS (UI) =========
    // open/close modals
    const show = el => el.classList.add("show");
    const hide = el => el.classList.remove("show");

    $("#btnShop").onclick = ()=>{ renderShop(); show($("#modalShop")); };
    $("#closeShop").onclick = ()=> hide($("#modalShop"));
    $("#btnInventory").onclick = ()=>{ renderInventory(); show($("#modalInv")); };
    $("#closeInv").onclick = ()=> hide($("#modalInv"));
    $("#btnQuests").onclick = ()=>{ renderQuests(); show($("#modalQuests")); };
    $("#closeQuests").onclick = ()=> hide($("#modalQuests"));
    $("#btnMini").onclick = ()=> show($("#modalMini"));
    $("#closeMini").onclick = ()=> hide($("#modalMini"));
    $("#btnLeaderboard").onclick = ()=>{ renderLB(); getGlobal(); show($("#modalLB")); };
    $("#closeLB").onclick = ()=> hide($("#modalLB"));
    $("#btnSettings").onclick = ()=> show($("#modalSettings"));
    $("#closeSettings").onclick = ()=> hide($("#modalSettings"));

    // shop clicks
    $("#modalShop").addEventListener("click",(e)=>{
      const buyKey = e.target.dataset.buy;
      if (!buyKey) return;
      const premium = !!e.target.dataset.premium;
      const list = premium? PREMIUM : REGULAR;
      const it = list.find(x=>x.key===buyKey);
      if (it) buyItem(it);
    });
    // inventory clicks
    $("#modalInv").addEventListener("click",(e)=>{
      const u = e.target.dataset.use; if (u){ useConsumable(u); renderInventory(); return; }
      const t = e.target.dataset.toggle; if (t){ toggleAccessory(t); renderInventory(); }
    });

    // mini game
    $("#startMini").onclick = ()=> startMini();
    $("#miniPet").addEventListener("click", ()=>{
      if (miniLeft>0){
        miniScore++; $("#miniScore").textContent = miniScore;
      }
    });

    // leaderboard buttons
    $("#syncLocal").onclick = ()=>{ refreshLocalLB(); renderLB(); };
    $("#pushGlobal").onclick = ()=> pushGlobal();

    // settings
    $("#wipeSave").onclick = ()=>{
      if (!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?")) return;
      localStorage.removeItem(storageKey(state.user.id));
      location.reload();
    };
    $("#devCoins").onclick = ()=>{ giveCoins(1000); saveState(); };
    $("#devAcc").onclick   = ()=>{ state.inventory.accessories={bow:true,shades:true,crown:true}; saveState(); };

    // ========= TOAST =========
    let toastTimer=null;
    function toast(msg){
      tg?.showPopup ? tg.showPopup({message:msg}) : (()=>{
        clearTimeout(toastTimer);
        let el = document.getElementById("toast");
        if (!el){
          el = document.createElement("div");
          el.id = "toast";
          el.style.cssText = "position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111c2a;color:#eaf6ff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,.35);z-index:9999;font-size:14px";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.opacity = "1";
        toastTimer = setTimeout(()=>{ el.style.opacity="0"; }, 1600);
      })();
    }

    // ========= INIT =========
    let state = loadState();

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if (tg?.initDataUnsafe?.user?.first_name){
      $("#username").textContent = `–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.user.first_name}!`;
    }

    renderAll();

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ: –∫–ª–∏–∫ –ø–æ –ø–∏—Ç–æ–º—Ü—É –¥–∞—ë—Ç –Ω–µ–º–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    $("#petBox").addEventListener("click", ()=>{
      state.stats.mood = clamp(state.stats.mood + 2, 0, 100);
      saveState();
    });

    // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)
    if (!state.leaderboardLocal || !state.leaderboardLocal.length){
      refreshLocalLB();
    }
  </script>
</body>
</html>

