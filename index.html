<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tamagocho</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b1420;
      --panel:#111a28;
      --panel-2:#0e1724;
      --border:#1e2a3c;
      --text:#e6eef8;
      --muted:#9bb2d0;
      --accent:#58b0ff;
      --ok:#35d39e;
      --warn:#f5a623;
      --bad:#ff6b6b;
      --chip:#172335;
      --chip-2:#1a2a3f;
      --btn:#18273b;
      --btn-hover:#203247;
      --shadow:0 8px 32px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Arial;
    }
    .wrap{
      max-width:420px; margin:0 auto; padding:18px 16px 28px 16px;
    }
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--border);
    }
    .title{font-weight:700}
    .seeds{display:inline-flex; align-items:center; gap:8px; background:var(--chip);
      padding:8px 10px; border-radius:12px; font-weight:700}
    .grid-btns{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
      padding:12px 12px 0;
    }
    .btn{
      background:var(--btn); color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:12px; cursor:pointer; text-align:center;
      user-select:none; transition:.15s background-color;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn.warn{border-color:#3a2b10; background:#241a0c}
    .btn.ok{border-color:#0e3a2c; background:#0c261e}
    .content{padding:12px}
    /* >>> 3D –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –≤—ã—à–µ –∏ —à–∏—Ä–µ */
    #hamster3d{
      width:100%; height:520px; background:#0b1420;
      border:1px solid var(--border); border-radius:16px; overflow:hidden;
    }
    /* –ë–∞—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ */
    .stats{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px;
    }
    .stat{
      background:var(--panel-2); border:1px solid var(--border); border-radius:12px;
      padding:12px; font-size:14px;
    }
    .bar{height:8px; background:#0d2033; border-radius:999px; overflow:hidden; margin-top:8px}
    .bar > span{display:block; height:100%; background:var(--accent)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:50;
      background:rgba(2,10,18,.6); backdrop-filter:blur(3px);
    }
    .modal.show{display:grid}
    .sheet{
      width:min(94vw,420px); max-height:86vh; overflow:auto;
      background:var(--panel); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow)
    }
    .sheet .head{
      padding:12px 14px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center
    }
    .list{padding:8px 12px}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--border); background:var(--panel-2);
      padding:10px; border-radius:12px; margin:8px 0;
    }
    .muted{color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; background:var(--chip-2); padding:6px 8px; border-radius:999px; font-size:12px}
    .inline{display:inline-flex; gap:8px; align-items:center}
    .danger{color:#ff9c9c}
    .hidden{display:none}

    /* –ú–∏–Ω–∏-–∏–≥—Ä–∞ */
    .mini{
      padding:10px 12px; color:var(--text); font-size:14px;
    }
    .mini canvas{width:100%; height:240px; background:#0d2033; border:1px solid var(--border); border-radius:12px}

    .admin-grid{display:grid; gap:10px; padding:12px}
    input,select{
      width:100%; background:#0f1a27; color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:10px;
    }
    .footnote{padding:10px 12px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">üêπ Tamagocho</div>
        <div class="seeds" id="seedsView">Seeds: 0</div>
      </div>

      <div class="grid-btns">
        <div class="btn" data-open="#shop">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="btn" data-open="#inv">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <div class="btn" data-open="#quests">üó∫Ô∏è –ö–≤–µ—Å—Ç—ã</div>
        <div class="btn" data-open="#mini">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞</div>
        <div class="btn" data-open="#board">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
        <div class="btn" id="adminBtn" data-open="#admin">‚öôÔ∏è –ê–¥–º–∏–Ω</div>
      </div>

      <div class="content">
        <div id="hamster3d"></div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="row">
            <div class="inline">üíö –°—ã—Ç–æ—Å—Ç—å</div>
            <b id="satVal">0%</b>
          </div>
          <div class="bar"><span id="satBar" style="width:0%"></span></div>
          <div class="row" style="margin-top:8px">
            <div class="pill">ü•Ñ –ü–æ–ª–Ω–∞—è</div>
            <div class="pill inline" id="feedBtn">ü™ô +10</div>
          </div>
        </div>

        <div class="stat">
          <div class="row">
            <div class="inline">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
            <b id="engVal">0%</b>
          </div>
          <div class="bar"><span id="engBar" style="width:0%"></span></div>
          <div class="row" style="margin-top:8px">
            <div class="pill">üîã –ü–æ–ª–Ω–∞—è</div>
            <div class="pill inline" id="sleepBtn">ü™ô +10</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= –ú–û–î–ê–õ–ö–ò ======= -->
  <!-- –ú–∞–≥–∞–∑–∏–Ω -->
  <div id="shop" class="modal"><div class="sheet">
    <div class="head">
      <b>üõí –ú–∞–≥–∞–∑–∏–Ω</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="list" id="shopList"></div>
    <div class="footnote">–ü—Ä–µ–º–∏—É–º-–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –±—É–¥—É—Ç –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ (–ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ). –°–æ–∑–¥–∞—Ç–µ–ª—é ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</div>
  </div></div>

  <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
  <div id="inv" class="modal"><div class="sheet">
    <div class="head">
      <b>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="list" id="invList"></div>
  </div></div>

  <!-- –ö–≤–µ—Å—Ç—ã -->
  <div id="quests" class="modal"><div class="sheet">
    <div class="head">
      <b>üó∫Ô∏è –ö–≤–µ—Å—Ç—ã</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="list" id="questList"></div>
  </div></div>

  <!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞ -->
  <div id="mini" class="modal"><div class="sheet">
    <div class="head">
      <b>üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞ | –ö–ª–∏–∫–µ—Ä</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="mini">
      <p class="muted">–ö–ª–∏–∫–∞–π –ø–æ —Ö–æ–º—è–∫—É –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –∑–∞ 10 —Å–µ–∫—É–Ω–¥. –ù–∞–≥—Ä–∞–¥–∞ ‚Äî Seeds.</p>
      <div style="display:grid;gap:8px">
        <canvas id="miniCanvas" width="380" height="240"></canvas>
        <div class="row">
          <div>–û—á–∫–∏: <b id="miniScore">0</b></div>
          <div>–í—Ä–µ–º—è: <b id="miniTime">0</b></div>
          <div class="btn ok" id="miniStart">‚ñ∂ –°—Ç–∞—Ä—Ç</div>
        </div>
      </div>
    </div>
  </div></div>

  <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
  <div id="board" class="modal"><div class="sheet">
    <div class="head">
      <b>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π)</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="list" id="boardList"></div>
    <div class="footnote">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ–¥–∫–ª—é—á–∏–º, –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∏–º –±–µ–∫–µ–Ω–¥.</div>
  </div></div>

  <!-- –ê–¥–º–∏–Ω (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å) -->
  <div id="admin" class="modal"><div class="sheet">
    <div class="head">
      <b>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Å–æ–∑–¥–∞—Ç–µ–ª—å)</b>
      <div class="btn" data-close>‚úñ</div>
    </div>
    <div class="admin-grid">
      <div>
        <label>–í—ã–¥–∞—Ç—å Seeds</label>
        <input type="number" id="admSeeds" value="100" />
        <div class="btn ok" id="giveSeeds">–í—ã–¥–∞—Ç—å</div>
      </div>
      <div>
        <label>–í—ã–¥–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä</label>
        <select id="admItem"></select>
        <div class="btn ok" id="giveItem">–í—ã–¥–∞—Ç—å</div>
      </div>
      <div class="muted">–≠—Ç–æ –Ω–µ –¥–æ–Ω–∞—Ç, –∞ —É–¥–æ–±–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è. –í–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ —Ç—ã.</div>
    </div>
  </div></div>

  <!-- ========= –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ========= -->
  <script>
    // Telegram WebApp
    const tg = window.Telegram?.WebApp || null;
    tg?.ready();
    tg?.expand();

    const CREATOR_ID = 1907547038;  // —Ç–æ–ª—å–∫–æ —Ç—ã –≤–∏–¥–∏—à—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –º–æ–∂–µ—à—å –±—Ä–∞—Ç—å –ø—Ä–µ–º–∏—É–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ
    const userId = tg?.initDataUnsafe?.user?.id ?? 0;
    const userName = tg?.initDataUnsafe?.user?.first_name ?? '–ò–≥—Ä–æ–∫';
    const IS_OWNER = (userId === CREATOR_ID);

    document.getElementById('adminBtn').classList.toggle('hidden', !IS_OWNER);

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ
    const KEY = `tama_v2_${userId || 'local'}`;
    const state = loadState() || {
      seeds: 250,
      sat: 80, // —Å—ã—Ç–æ—Å—Ç—å
      eng: 75, // —ç–Ω–µ—Ä–≥–∏—è
      inv: [],
      accessories: [],
      best: 0
    };

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(KEY) || '{}'); }catch{ return null }
    }
    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function fmt(n){ return new Intl.NumberFormat('ru-RU').format(n); }

    // UI –±–∏–Ω–¥—ã
    const seedsView = document.getElementById('seedsView');
    const satVal = document.getElementById('satVal');
    const satBar = document.getElementById('satBar');
    const engVal = document.getElementById('engVal');
    const engBar = document.getElementById('engBar');

    function redraw(){
      seedsView.textContent = `Seeds: ${fmt(state.seeds)}`;
      satVal.textContent = `${state.sat}%`; satBar.style.width = `${state.sat}%`;
      engVal.textContent = `${state.eng}%`; engBar.style.width = `${state.eng}%`;
    }
    redraw();

    // –ö–Ω–æ–ø–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–æ–≤ (–∑–∞ –≤–Ω—É—Ç—Ä. –≤–∞–ª—é—Ç—É)
    document.getElementById('feedBtn').onclick = ()=>{
      if(state.seeds < 10) return alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç Seeds.');
      state.seeds -= 10; state.sat = 100; saveState(); redraw();
    }
    document.getElementById('sleepBtn').onclick = ()=>{
      if(state.seeds < 10) return alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç Seeds.');
      state.seeds -= 10; state.eng = 100; saveState(); redraw();
    }

    // –ú–æ–¥–∞–ª–∫–∏
    document.querySelectorAll('[data-open]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const sel = el.getAttribute('data-open');
        document.querySelector(sel)?.classList.add('show');
      });
    });
    document.querySelectorAll('[data-close]').forEach(el=>{
      el.addEventListener('click', ()=> el.closest('.modal')?.classList.remove('show'));
    });
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click', (e)=> { if(e.target===m) m.classList.remove('show'); });
    });

    // –¢–æ–≤–∞—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞
    const GOODS = [
      { id:'food_small',  name:'–ú–∏—Å–∫–∞ —Å–µ–º–µ—á–µ–∫',     type:'consum',  add:{sat:100}, price:30,  premium:false },
      { id:'drink',       name:'–ü–æ–∏–ª–∫–∞',            type:'consum',  add:{eng:100}, price:30,  premium:false },
      { id:'food_big',    name:'–ü—Ä–µ–º–∏—É–º-–∫–æ—Ä–º XL',   type:'consum',  add:{sat:100,eng:100}, price:80, premium:false },

      { id:'bow',         name:'–ë–∞–Ω—Ç–∏–∫',            type:'acc',     price:0,   premium:true },
      { id:'hat',         name:'–®–ª—è–ø–∞ –¥–∂–µ–Ω—Ç–ª—å–º–µ–Ω–∞', type:'acc',     price:0,   premium:true },
      { id:'glasses',     name:'–û—á–∫–∏ –∑–≤–µ–∑–¥—ã',       type:'acc',     price:0,   premium:true }
    ];

    // –ú–∞–≥–∞–∑–∏–Ω: —Ä–µ–Ω–¥–µ—Ä
    const shopList = document.getElementById('shopList');
    function drawShop(){
      shopList.innerHTML = '';
      GOODS.forEach(g=>{
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<div><b>${g.name}</b> ${g.premium?'<span class="pill danger">–ü—Ä–µ–º–∏—É–º</span>':''}</div>
                          <div class="muted">${g.type==='consum'?'–†–∞—Å—Ö–æ–¥–Ω–∏–∫':'–ê–∫—Å–µ—Å—Å—É–∞—Ä'}</div>`;
        const buy = document.createElement('div'); buy.className='btn';
        buy.textContent = g.premium ? (IS_OWNER?'–ü–æ–ª—É—á–∏—Ç—å':'–°–∫–æ—Ä–æ üí≥') : `–ö—É–ø–∏—Ç—å ‚Äî ${g.price}ü™ô`;
        buy.onclick = ()=>{
          if(g.premium){
            if(!IS_OWNER) return alert('–ü—Ä–µ–º–∏—É–º-–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.');
            if(!state.accessories.includes(g.id)) state.accessories.push(g.id);
            saveState(); alert('–í—ã–¥–∞–Ω–æ!'); drawInv();
          }else{
            if(state.seeds<g.price) return alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç Seeds.');
            state.seeds -= g.price;
            if(g.type==='consum') state.inv.push(g.id);
            else if(!state.accessories.includes(g.id)) state.accessories.push(g.id);
            // –±–æ–Ω—É—Å –∫ —Å—Ç–∞—Ç–∞–º –¥–ª—è consum
            if(g.add){ if(g.add.sat) state.sat = 100; if(g.add.eng) state.eng = 100; }
            saveState(); redraw(); drawInv();
          }
        };
        row.append(left,buy); shopList.append(row);
      });
    }
    drawShop();

    // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
    const invList = document.getElementById('invList');
    function drawInv(){
      invList.innerHTML = '';
      // consumables
      const consumCounts = {};
      state.inv.forEach(id=>consumCounts[id]=(consumCounts[id]||0)+1);
      Object.entries(consumCounts).forEach(([id,qty])=>{
        const g = GOODS.find(x=>x.id===id);
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div><b>${g.name}</b><div class="muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}</div></div>`;
        const use = document.createElement('div'); use.className='btn ok'; use.textContent='–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å';
        use.onclick = ()=>{
          // –ø—Ä–∏–º–µ–Ω—è–µ–º
          const i = state.inv.indexOf(id);
          if(i>=0){ state.inv.splice(i,1); if(g.add){ if(g.add.sat) state.sat=100; if(g.add.eng) state.eng=100; } saveState(); redraw(); drawInv(); }
        };
        row.appendChild(use); invList.appendChild(row);
      });
      // accessories
      state.accessories.forEach(id=>{
        const g = GOODS.find(x=>x.id===id);
        if(!g) return;
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div><b>${g.name}</b><div class="muted">–ê–∫—Å–µ—Å—Å—É–∞—Ä</div></div>`;
        const wear = document.createElement('div'); wear.className='btn'; wear.textContent='–ù–∞–¥–µ—Ç—å';
        wear.onclick = ()=> alert('–í–∏–∑—É–∞–ª—å–Ω–æ–µ –Ω–∞–¥–µ–≤–∞–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –¥–æ–±–∞–≤–∏–º (–ø—Ä–∏–≤—è–∂–µ–º –∫ 3D).');
        row.appendChild(wear); invList.appendChild(row);
      });
      if(!invList.innerHTML) invList.innerHTML = `<div class="muted" style="padding:12px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`;
    }
    drawInv();

    // –ö–≤–µ—Å—Ç—ã (–ø—Ä–æ—Å—Ç—ã–µ –¥–µ–π–ª–∏–∫–∏)
    const questList = document.getElementById('questList');
    const QUESTS = [
      { id:'q_feed',  name:'–ù–∞–∫–æ—Ä–º–∏ —Ö–æ–º—è–∫–∞',   reward:20,  run:()=>{ state.sat=100; } },
      { id:'q_sleep', name:'–ü–æ–ª–æ–∂–∏ —Å–ø–∞—Ç—å',     reward:20,  run:()=>{ state.eng=100; } },
      { id:'q_play',  name:'–°—ã–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—É',reward:30,  run:()=>{} },
    ];
    function drawQuests(){
      questList.innerHTML='';
      QUESTS.forEach(q=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div><b>${q.name}</b><div class="muted">–ù–∞–≥—Ä–∞–¥–∞: ${q.reward} Seeds</div></div>`;
        const act = document.createElement('div'); act.className='btn ok'; act.textContent='–í—ã–ø–æ–ª–Ω–∏—Ç—å';
        act.onclick = ()=>{
          q.run(); state.seeds += q.reward; saveState(); redraw(); alert('–ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω!');
        };
        row.appendChild(act); questList.appendChild(row);
      });
    }
    drawQuests();

    // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Å–æ–∑–¥–∞—Ç–µ–ª—å)
    if(IS_OWNER){
      const sel = document.getElementById('admItem');
      GOODS.forEach(g=>{
        const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name;
        sel.appendChild(opt);
      });
      document.getElementById('giveSeeds').onclick = ()=>{
        const n = +document.getElementById('admSeeds').value||0;
        state.seeds += n; saveState(); redraw(); alert('–í—ã–¥–∞–Ω–æ');
      };
      document.getElementById('giveItem').onclick = ()=>{
        const id = sel.value;
        const g = GOODS.find(x=>x.id===id);
        if(!g) return;
        if(g.type==='consum') state.inv.push(id); else if(!state.accessories.includes(id)) state.accessories.push(id);
        saveState(); drawInv(); alert('–í—ã–¥–∞–Ω–æ');
      };
    }

    // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ª–æ–∫–∞–ª—å–Ω—ã–π
    function pushScore(score){
      const k = `${KEY}_board`;
      const arr = JSON.parse(localStorage.getItem(k)||'[]');
      arr.push({name:userName, score, ts:Date.now()});
      arr.sort((a,b)=>b.score-a.score);
      localStorage.setItem(k, JSON.stringify(arr.slice(0,50)));
    }
    function drawBoard(){
      const k = `${KEY}_board`;
      const arr = JSON.parse(localStorage.getItem(k)||'[]');
      const box = document.getElementById('boardList');
      box.innerHTML='';
      arr.forEach((r,i)=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div><b>#${i+1}. ${r.name}</b><div class="muted">${new Date(r.ts).toLocaleString()}</div></div>
                         <div><b>${r.score}</b></div>`;
        box.appendChild(row);
      });
      if(!box.innerHTML) box.innerHTML = `<div class="muted" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</div>`;
    }
    drawBoard();

    // ===== –ú–∏–Ω–∏-–∏–≥—Ä–∞ (–∫–ª–∏–∫–µ—Ä) =====
    (function(){
      const canvas = document.getElementById('miniCanvas');
      const ctx = canvas.getContext('2d');
      const startBtn = document.getElementById('miniStart');
      const scoreEl = document.getElementById('miniScore');
      const timeEl  = document.getElementById('miniTime');

      let score=0, time=0, running=false;
      let hx=190, hy=120, r=20; // –ø–æ–∑–∏—Ü–∏—è ¬´—Ü–µ–ª–∏¬ª

      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // —Ñ–æ–Ω
        ctx.fillStyle='#0f2238'; ctx.fillRect(0,0,canvas.width,canvas.height);
        // —Ü–µ–ª—å
        ctx.beginPath(); ctx.fillStyle='#ffb86c';
        ctx.arc(hx,hy,r,0,Math.PI*2); ctx.fill();
        // –ª–∏—Ü–æ
        ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(hx-6,hy-3,3,0,6.28); ctx.fill();
        ctx.beginPath(); ctx.arc(hx+6,hy-3,3,0,6.28); ctx.fill();
        ctx.fillStyle='#c94f4f'; ctx.beginPath(); ctx.arc(hx,hy+5,4,0,6.28); ctx.fill();
      }
      draw();

      canvas.addEventListener('click',(e)=>{
        if(!running) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX-rect.left, y = e.clientY-rect.top;
        const d = Math.hypot(x-hx,y-hy);
        if(d <= r){
          score++;
          scoreEl.textContent = score;
          // –Ω–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
          hx = 30 + Math.random()*(canvas.width-60);
          hy = 30 + Math.random()*(canvas.height-60);
          draw();
        }
      });

      startBtn.addEventListener('click', ()=>{
        if(running) return;
        score=0; time=10; running=true;
        scoreEl.textContent='0'; timeEl.textContent=time;
        const tick = setInterval(()=>{
          if(!running) return clearInterval(tick);
          time--; timeEl.textContent=time;
          if(time<=0){
            running=false; clearInterval(tick);
            const reward = 5 + score; // –ø—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞
            state.seeds += reward;
            if(score>state.best){ state.best=score; pushScore(score); drawBoard(); }
            saveState(); redraw();
            alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –û—á–∫–∏: ${score}. –ù–∞–≥—Ä–∞–¥–∞: ${reward} Seeds.`);
          }
        },1000);
      });
    })();
  </script>

  <!-- ========= 3D –•–û–ú–Ø–ö (–∫—Ä—É–ø–Ω—ã–π) ========= -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/loaders/GLTFLoader.js';

    const container = document.getElementById('hamster3d');

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, container.clientWidth/container.clientHeight, 0.01, 100);
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    // —Å–≤–µ—Ç
    const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 1.7);
    const dir  = new THREE.DirectionalLight(0xffffff, 2.4);
    dir.position.set(2.2, 4.2, 3.2);
    scene.add(hemi, dir);

    // –ø–æ–¥—Å—Ç–∞–≤–∫–∞
    const ground = new THREE.Mesh(
      new THREE.CircleGeometry(3.2, 64),
      new THREE.MeshStandardMaterial({ color: 0x142338, roughness: 0.96, metalness: 0 })
    );
    ground.rotation.x = -Math.PI/2; ground.position.y = -1.0;
    scene.add(ground);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.enablePan = false;

    function fitCameraToObject(obj, offset = 1.12) { // —á—É—Ç—å –±–ª–∏–∂–µ
      const box   = new THREE.Box3().setFromObject(obj);
      const size  = box.getSize(new THREE.Vector3());
      const center= box.getCenter(new THREE.Vector3());

      obj.position.sub(center);
      obj.position.y = -box.min.y;

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov    = camera.fov * (Math.PI/180);
      let dist     = (maxDim/2) / Math.tan(fov/2);
      dist = dist * offset;

      camera.position.set(0, maxDim * 0.66, dist);
      controls.target.set(0, maxDim * 0.38, 0);

      controls.minDistance = maxDim * 0.55;
      controls.maxDistance = maxDim * 2.2;
      controls.update();
    }

    const loader = new GLTFLoader();
    loader.load('./hamster.glb', (gltf) => {
      const model = gltf.scene;
      // –°–¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ç–Ω–æ –∫—Ä—É–ø–Ω–µ–µ
      model.scale.setScalar(2.8);        // ‚Üë –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—à—Ç–∞–±
      scene.add(model);
      fitCameraToObject(model, 1.10);    // ‚Üë –∫–∞–º–µ—Ä–∞ –±–ª–∏–∂–µ

      // –ª—ë–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
      const clock = new THREE.Clock();
      (function wiggle(){
        const t = clock.getElapsedTime();
        model.rotation.y = Math.sin(t * 0.6) * 0.22;
        requestAnimationFrame(wiggle);
      })();
    }, undefined, (err)=>{
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ hamster.glb', err);
      const fb = new THREE.Mesh(
        new THREE.SphereGeometry(1.1, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xffc78f, roughness: .6 })
      );
      scene.add(fb); fitCameraToObject(fb, 1.2);
    });

    const ro = new ResizeObserver(() => {
      const w = container.clientWidth || 300;
      const h = container.clientHeight || 200;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });
    ro.observe(container);

    (function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
